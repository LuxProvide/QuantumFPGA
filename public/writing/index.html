
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Webinar/Tutorial on how to use the Intel® FPGA for Quantum Computing">
      
      
        <meta name="author" content="Emmanuel Kieffer">
      
      
        <link rel="canonical" href="https://LuxProvide.github.io/QuantumFPGA/writing/">
      
      
        <link rel="prev" href="../qcfpga/">
      
      
      
      <link rel="icon" href="../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>QES programming using Intel® oneAPI for FPGA - Introduction to Quantum Exact Simulation (QES) with Intel® FPGA</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#developing-sycl-programs-for-intel-fpga-cards" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Introduction to Quantum Exact Simulation (QES) with Intel® FPGA" class="md-header__button md-logo" aria-label="Introduction to Quantum Exact Simulation (QES) with Intel® FPGA" data-md-component="logo">
      
<img src="../assets/LuxProvide_logo_white.svg" alt="logo" style="width:3.0rem">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Introduction to Quantum Exact Simulation (QES) with Intel® FPGA
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              QES programming using Intel® oneAPI for FPGA
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/LuxProvide/QuantumFPGA" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    LuxProvide/QuantumFPGA
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Introduction to Quantum Exact Simulation (QES) with Intel® FPGA" class="md-nav__button md-logo" aria-label="Introduction to Quantum Exact Simulation (QES) with Intel® FPGA" data-md-component="logo">
      
<img src="../assets/LuxProvide_logo_white.svg" alt="logo" style="width:3.0rem">

    </a>
    Introduction to Quantum Exact Simulation (QES) with Intel® FPGA
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/LuxProvide/QuantumFPGA" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    LuxProvide/QuantumFPGA
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Course description
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Prerequisites
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Prerequisites
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tmux_screen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Persistent terminal sessions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../meluxina/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Meluxina
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FPGA computing for the HPC ecosystem
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../qcfpga/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    QES with QCFPGA on JupyterLab
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    QES programming using Intel® oneAPI for FPGA
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    QES programming using Intel® oneAPI for FPGA
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#anatomy-of-a-sycl-program" class="md-nav__link">
    <span class="md-ellipsis">
      Anatomy of a SYCL program
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-management" class="md-nav__link">
    <span class="md-ellipsis">
      Data Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unified-shared-memory-usm" class="md-nav__link">
    <span class="md-ellipsis">
      Unified Shared Memory (USM)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-accessors" class="md-nav__link">
    <span class="md-ellipsis">
      Buffer &amp; accessors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queue" class="md-nav__link">
    <span class="md-ellipsis">
      Queue
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Queue">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#explicit-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Explicit dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implicit-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Implicit dependencies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallelism-model-for-fpga" class="md-nav__link">
    <span class="md-ellipsis">
      Parallelism model for FPGA
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parallelism model for FPGA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pipelining-with-nd-range-kernels" class="md-nav__link">
    <span class="md-ellipsis">
      Pipelining with ND-range kernels
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipelining-with-single-work-item-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Pipelining with single-work item (loop)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#anatomy-of-a-sycl-program" class="md-nav__link">
    <span class="md-ellipsis">
      Anatomy of a SYCL program
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-management" class="md-nav__link">
    <span class="md-ellipsis">
      Data Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Data Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unified-shared-memory-usm" class="md-nav__link">
    <span class="md-ellipsis">
      Unified Shared Memory (USM)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#buffer-accessors" class="md-nav__link">
    <span class="md-ellipsis">
      Buffer &amp; accessors
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#queue" class="md-nav__link">
    <span class="md-ellipsis">
      Queue
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Queue">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#explicit-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Explicit dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implicit-dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      Implicit dependencies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parallelism-model-for-fpga" class="md-nav__link">
    <span class="md-ellipsis">
      Parallelism model for FPGA
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parallelism model for FPGA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pipelining-with-nd-range-kernels" class="md-nav__link">
    <span class="md-ellipsis">
      Pipelining with ND-range kernels
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pipelining-with-single-work-item-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Pipelining with single-work item (loop)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                



                  

  
  


<h1 id="developing-sycl-programs-for-intel-fpga-cards">Developing SYCL programs for Intel® FPGA cards<a class="headerlink" href="#developing-sycl-programs-for-intel-fpga-cards" title="Permanent link">&para;</a></h1>
<h2 id="anatomy-of-a-sycl-program">Anatomy of a SYCL program<a class="headerlink" href="#anatomy-of-a-sycl-program" title="Permanent link">&para;</a></h2>
<p><a href="https://www.khronos.org/files/sycl/sycl-2020-reference-guide.pdf"><img alt="" src="../images/sycl_program.png" /></a></p>
<h2 id="data-management">Data Management<a class="headerlink" href="#data-management" title="Permanent link">&para;</a></h2>
<p>In the context of SYCL, Unified Shared Memory (USM) and buffers represent two different ways to handle memory and data management. They offer different levels of abstraction and ease of use, and the choice between them may depend on the specific needs of an application. Here's a breakdown of the differences:</p>
<h3 id="unified-shared-memory-usm">Unified Shared Memory (USM)<a class="headerlink" href="#unified-shared-memory-usm" title="Permanent link">&para;</a></h3>
<p>Unified Shared Memory is a feature that simplifies memory management by providing a shared memory space across the host and various devices, like CPUs, GPUs, and FPGAs. USM provides three different types of allocations:</p>
<ol>
<li><strong>Device Allocations</strong>: Allocated memory is accessible only by the device.</li>
<li><strong>Host Allocations</strong>: Allocated memory is accessible by the host and can be accessed by devices. However, the allocated memory is stored on the host global memory. </li>
<li><strong>Shared Allocations</strong>: Allocated memory is accessible by both the host and devices. The allocated memory is present in both global memories and it is synchronized between host and device.</li>
</ol>
<p>USM allows for more straightforward coding, akin to standard C++ memory management, and may lead to code that is easier to write and maintain. </p>
<div class="admonition warning">
<p class="admonition-title">FPGA support</p>
<p>SYCL USM host allocations are only supported by some BSPs, such as the Intel® FPGA Programmable Acceleration Card (PAC) D5005 (previously known as Intel® FPGA Programmable Acceleration Card (PAC) with Intel® Stratix® 10 SX FPGA). Check with your BSP vendor to see if they support SYCL USM host allocations.</p>
</div>
<p>Using SYCL, you can verify if you have access to the different features:</p>
<div class="admonition example">
<p class="admonition-title">Verify USM capabilities</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">.</span><span class="n">has</span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">aspect</span><span class="o">::</span><span class="n">usm_shared_allocations</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w">    </span><span class="cp"># Try to default to host allocation only</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">.</span><span class="n">has</span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">aspect</span><span class="o">::</span><span class="n">usm_host_allocations</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">        </span><span class="cp"># Default to device and explicit data movement</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="n">host_array</span><span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">my_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc_device</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">Q</span><span class="p">);</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">        </span><span class="cp"># Ok my_array is located on host memory but transferred to device as needed</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">        </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">my_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc_host</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">Q</span><span class="p">);</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">        </span><span class="cp"># Ok my_array is located on both global memories and synchronized automatically </span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">        </span><span class="kt">int</span><span class="o">*</span><span class="w"> </span><span class="n">shared_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc_shared</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">Q</span><span class="p">);</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="p">}</span>
</span></code></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">That's not all</p>
<ul>
<li>Concurrent accesses and atomic modificationes are not necessarily available even if you have host and shared capabilities.</li>
<li>You need to verify <code>aspect::usm_atomic_shared_allocations</code> and <code>aspect::usm_atomic_host_allocations</code>.</li>
</ul>
</div>
<div class="admonition warning">
<p class="admonition-title">Bittware 520N-MX</p>
<p>The USM host allocations is not supported by some BSPs. We will therefore use explicit data movement</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Explicit USM</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Question</label><label for="__tabbed_1_2">Solution</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ul>
<li>Go to the <code>GettingStarted/fpga_compile/part4_dpcpp_lambda_buffers/src</code></li>
<li>Replace the original code with explicit USM code </li>
<li>Verify your code using emulation</li>
</ul>
</div>
<div class="tabbed-block">
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">  1</a></span>
<span class="normal"><a href="#__codelineno-1-2">  2</a></span>
<span class="normal"><a href="#__codelineno-1-3">  3</a></span>
<span class="normal"><a href="#__codelineno-1-4">  4</a></span>
<span class="normal"><a href="#__codelineno-1-5">  5</a></span>
<span class="normal"><a href="#__codelineno-1-6">  6</a></span>
<span class="normal"><a href="#__codelineno-1-7">  7</a></span>
<span class="normal"><a href="#__codelineno-1-8">  8</a></span>
<span class="normal"><a href="#__codelineno-1-9">  9</a></span>
<span class="normal"><a href="#__codelineno-1-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-1-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-1-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-1-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-1-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-1-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-1-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-1-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-1-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-1-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-1-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-1-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-1-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-1-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-1-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-1-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-1-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-1-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-1-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-1-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-1-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-1-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-1-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-1-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-1-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-1-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-1-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-1-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-1-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-1-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-1-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-1-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-1-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-1-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-1-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-1-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-1-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-1-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-1-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-1-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-1-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-1-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-1-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-1-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-1-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-1-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-1-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-1-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-1-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-1-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-1-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-1-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-1-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-1-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-1-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-1-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-1-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-1-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-1-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-1-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-1-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-1-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-1-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-1-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-1-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-1-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-1-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-1-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-1-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-1-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-1-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-1-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-1-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-1-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-1-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-1-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-1-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-1-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-1-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-1-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-1-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-1-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-1-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-1-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-1-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-1-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-1-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-1-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-1-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-1-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-1-100">100</a></span>
<span class="normal"><a href="#__codelineno-1-101">101</a></span>
<span class="normal"><a href="#__codelineno-1-102">102</a></span>
<span class="normal"><a href="#__codelineno-1-103">103</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="c1">// oneAPI headers</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/ext/intel/fpga_extensions.hpp&gt;</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="c1">// Forward declare the kernel name in the global scope. This is an FPGA best</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1">// practice that reduces name mangling in the optimization reports.</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">VectorAddID</span><span class="p">;</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kt">void</span><span class="w"> </span><span class="nf">VectorAdd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">vec_a_in</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">vec_b_in</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">vec_c_out</span><span class="p">,</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">               </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">idx</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">a_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_a_in</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">b_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_b_in</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_val</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b_val</span><span class="p">;</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="n">vec_c_out</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="p">}</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="c1">// Use compile-time macros to select either:</span>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">    </span><span class="c1">//  - the FPGA emulator device (CPU emulation of the FPGA)</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">    </span><span class="c1">//  - the FPGA device (a real FPGA)</span>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">    </span><span class="c1">//  - the simulator device</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="cp">#if FPGA_SIMULATOR</span>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_simulator_selector_v</span><span class="p">;</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">    </span><span class="cp">#elif FPGA_HARDWARE</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_selector_v</span><span class="p">;</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">    </span><span class="cp">#else  </span><span class="c1">// #if FPGA_EMULATOR</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_emulator_selector_v</span><span class="p">;</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">    </span><span class="cp">#endif</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36"></a>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">    </span><span class="c1">// create the device queue</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">    </span><span class="n">sycl</span><span class="o">::</span><span class="n">queue</span><span class="w"> </span><span class="n">q</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39"></a>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">    </span><span class="c1">// make sure the device supports USM host allocations</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">get_device</span><span class="p">();</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42"></a>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Running on device: &quot;</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="n">get_info</span><span class="o">&lt;</span><span class="n">sycl</span><span class="o">::</span><span class="n">info</span><span class="o">::</span><span class="n">device</span><span class="o">::</span><span class="n">name</span><span class="o">&gt;</span><span class="p">().</span><span class="n">c_str</span><span class="p">()</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46"></a>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">    </span><span class="c1">// declare arrays and fill them</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">host_vec_a</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">host_vec_b</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">host_vec_c</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc_device</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kVectSize</span><span class="p">,</span><span class="n">q</span><span class="p">);</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc_device</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kVectSize</span><span class="p">,</span><span class="n">q</span><span class="p">);</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc_device</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">kVectSize</span><span class="p">,</span><span class="n">q</span><span class="p">);</span>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55"></a><span class="w">      </span><span class="n">host_vec_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">      </span><span class="n">host_vec_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kVectSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58"></a>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;add two vectors of size &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60"></a>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="w">    </span><span class="n">q</span><span class="p">.</span><span class="n">memcpy</span><span class="p">(</span><span class="n">vec_a</span><span class="p">,</span><span class="w"> </span><span class="n">host_vec_a</span><span class="p">,</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)).</span><span class="n">wait</span><span class="p">();</span>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="w">    </span><span class="n">q</span><span class="p">.</span><span class="n">memcpy</span><span class="p">(</span><span class="n">vec_b</span><span class="p">,</span><span class="w"> </span><span class="n">host_vec_b</span><span class="p">,</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)).</span><span class="n">wait</span><span class="p">();</span>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63"></a>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64"></a>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65"></a>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66"></a><span class="w">    </span><span class="n">q</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">VectorAddID</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67"></a><span class="w">        </span><span class="n">VectorAdd</span><span class="p">(</span><span class="n">vec_a</span><span class="p">,</span><span class="w"> </span><span class="n">vec_b</span><span class="p">,</span><span class="w"> </span><span class="n">vec_c</span><span class="p">,</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">);</span>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68"></a><span class="w">      </span><span class="p">}).</span><span class="n">wait</span><span class="p">();</span>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69"></a>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70"></a><span class="w">    </span><span class="n">q</span><span class="p">.</span><span class="n">memcpy</span><span class="p">(</span><span class="n">host_vec_c</span><span class="p">,</span><span class="w"> </span><span class="n">vec_c</span><span class="p">,</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)).</span><span class="n">wait</span><span class="p">();</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71"></a>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72"></a><span class="w">    </span><span class="c1">// verify that VC is correct</span>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74"></a><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">host_vec_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">host_vec_b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">host_vec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;idx=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;: result &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">host_vec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, expected (&quot;</span>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77"></a><span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;) A=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">host_vec_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; + B=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">host_vec_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78"></a><span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79"></a><span class="w">        </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82"></a>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;PASSED&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;FAILED&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84"></a>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85"></a><span class="w">    </span><span class="n">sycl</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">vec_a</span><span class="p">,</span><span class="n">q</span><span class="p">);</span>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86"></a><span class="w">    </span><span class="n">sycl</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">vec_b</span><span class="p">,</span><span class="n">q</span><span class="p">);</span>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87"></a><span class="w">    </span><span class="n">sycl</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">vec_c</span><span class="p">,</span><span class="n">q</span><span class="p">);</span>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89"></a><span class="w">    </span><span class="c1">// Catches exceptions in the host code.</span>
</span><span id="__span-1-90"><a id="__codelineno-1-90" name="__codelineno-1-90"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Caught a SYCL host exception:</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-1-91"><a id="__codelineno-1-91" name="__codelineno-1-91"></a>
</span><span id="__span-1-92"><a id="__codelineno-1-92" name="__codelineno-1-92"></a><span class="w">    </span><span class="c1">// Most likely the runtime couldn&#39;t find FPGA hardware!</span>
</span><span id="__span-1-93"><a id="__codelineno-1-93" name="__codelineno-1-93"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">code</span><span class="p">().</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CL_DEVICE_NOT_FOUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-1-94"><a id="__codelineno-1-94" name="__codelineno-1-94"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting an FPGA, please ensure that your &quot;</span>
</span><span id="__span-1-95"><a id="__codelineno-1-95" name="__codelineno-1-95"></a><span class="w">                   </span><span class="s">&quot;system has a correctly configured FPGA board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-1-96"><a id="__codelineno-1-96" name="__codelineno-1-96"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Run sys_check in the oneAPI root directory to verify.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-1-97"><a id="__codelineno-1-97" name="__codelineno-1-97"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting the FPGA emulator, compile with &quot;</span>
</span><span id="__span-1-98"><a id="__codelineno-1-98" name="__codelineno-1-98"></a><span class="w">                   </span><span class="s">&quot;-DFPGA_EMULATOR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-1-99"><a id="__codelineno-1-99" name="__codelineno-1-99"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-1-100"><a id="__codelineno-1-100" name="__codelineno-1-100"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">terminate</span><span class="p">();</span>
</span><span id="__span-1-101"><a id="__codelineno-1-101" name="__codelineno-1-101"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-1-102"><a id="__codelineno-1-102" name="__codelineno-1-102"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
</span><span id="__span-1-103"><a id="__codelineno-1-103" name="__codelineno-1-103"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<h3 id="buffer-accessors">Buffer &amp; accessors<a class="headerlink" href="#buffer-accessors" title="Permanent link">&para;</a></h3>
<p>Buffers and accessors are key abstractions that enable memory management and data access across various types of devices like CPUs, GPUs, DSPs, etc.</p>
<ol>
<li>
<p><strong>Buffers</strong>:Buffers in SYCL are objects that represent a region of memory accessible by the runtime. They act as containers for data and provide a way to abstract the memory management across host and device memories. This allows for efficient data movement and optimization by the runtime, as it can manage the data movement between host and device memory transparently.</p>
</li>
<li>
<p><strong>Accessors</strong>:Accessors provide a way to access the data inside buffers. They define the type of access (read, write, read-write) and can be used within kernels to read from or write to buffers.</p>
</li>
</ol>
<div class="admonition success">
<p class="admonition-title">Advantage</p>
<p>Through the utilization of these accessors, the SYCL runtime examines the interactions with the buffers and constructs a dependency graph that maps the relationship between host and device functions. This enables the runtime to automatically orchestrate the transfer of data and the sequencing of kernel activities.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Using Buffers and Accessors</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;array&gt;</span><span class="c1"> </span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="c1">// oneAPI headers</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/ext/intel/fpga_extensions.hpp&gt;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">Kernel</span><span class="p">;</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in_array</span><span class="p">;</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="n">N</span><span class="o">&gt;</span><span class="w"> </span><span class="n">out_array</span><span class="p">;</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">        </span><span class="n">in_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="n">queue</span><span class="w"> </span><span class="nf">device_queue</span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_selector_v</span><span class="p">);</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="c1">// This one is very important to define the buffer scope</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">      </span><span class="c1">// buffer&lt;int, 1&gt; in_device_buf(in.data(), in.size());</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">      </span><span class="c1">// Or more convenient</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">      </span><span class="n">buffer</span><span class="w"> </span><span class="nf">in_device_buf</span><span class="p">(</span><span class="n">in_array</span><span class="p">);</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">      </span><span class="n">buffer</span><span class="w"> </span><span class="nf">out_device_buf</span><span class="p">(</span><span class="n">out_array</span><span class="p">);</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">      </span><span class="n">device_queue</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">        </span><span class="n">accessor</span><span class="w"> </span><span class="nf">in</span><span class="p">(</span><span class="n">in_device_buf</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">read_only</span><span class="p">);</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">        </span><span class="n">accessor</span><span class="w"> </span><span class="nf">out</span><span class="p">(</span><span class="n">out_device_buf</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">write_only</span><span class="p">,</span><span class="w"> </span><span class="n">no_init</span><span class="p">);</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">Kernel</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">      </span><span class="p">};</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">    </span><span class="c1">// Accessor going out of the scope</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">    </span><span class="c1">// Data has been copied back !!!</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="admonition warning">
<p class="admonition-title">What about memory accesses in FPGA ? </p>
<p>For FPGAs, the access pattern, access width, and coalescing of memory accesses can significantly affect performance. You might want to make use of various attributes and pragmas specific to your compiler and FPGA to guide the compiler in optimizing memory accesses.</p>
</div>
<ul>
<li>The <code>vector_add.cpp</code> source code introduced in the <a href="../compile/">compiling</a> section relies on buffers and accessors. Although DPC++ is built on top of SYCL, the use of specific hardware needs some attentions</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Executing the FPGA bitstream</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Question</label><label for="__tabbed_2_2">Solution</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ul>
<li>Go to <code>/project/home/p200117/FPGA</code></li>
<li>We have build to different FPGA bitstream versions of <code>vector_add.cpp</code>:</li>
<li>Go to the folder <code>01-no_data_alignment/src</code> and execute the code on the FPGA card. What do you see ?</li>
<li>Now go to the folder <code>02-with_data_alignment/src</code> and execute the code on the FPGA card. How could we align data properly ?</li>
</ul>
</div>
<div class="tabbed-block">
<p><div class="language-bash highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>Running<span class="w"> </span>on<span class="w"> </span>device:<span class="w"> </span>p520_hpc_m210h_g3x16<span class="w"> </span>:<span class="w"> </span>BittWare<span class="w"> </span>Stratix<span class="w"> </span><span class="m">10</span><span class="w"> </span>MX<span class="w"> </span>OpenCL<span class="w"> </span>platform<span class="w"> </span><span class="o">(</span>aclbitt_s10mx_pcie0<span class="o">)</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>add<span class="w"> </span>two<span class="w"> </span>vectors<span class="w"> </span>of<span class="w"> </span>size<span class="w"> </span><span class="m">256</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>**<span class="w"> </span>WARNING:<span class="w"> </span><span class="o">[</span>aclbitt_s10mx_pcie0<span class="o">]</span><span class="w"> </span>NOT<span class="w"> </span>using<span class="w"> </span>DMA<span class="w"> </span>to<span class="w"> </span>transfer<span class="w"> </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span>host<span class="w"> </span>to<span class="w"> </span>device<span class="w"> </span>because<span class="w"> </span>of<span class="w"> </span>lack<span class="w"> </span>of<span class="w"> </span>alignment
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>**<span class="w">                 </span>host<span class="w"> </span>ptr<span class="w"> </span><span class="o">(</span>0xb60b350<span class="o">)</span><span class="w"> </span>and/or<span class="w"> </span>dev<span class="w"> </span>offset<span class="w"> </span><span class="o">(</span>0x400<span class="o">)</span><span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>aligned<span class="w"> </span>to<span class="w"> </span><span class="m">64</span><span class="w"> </span>bytes
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>**<span class="w"> </span>WARNING:<span class="w"> </span><span class="o">[</span>aclbitt_s10mx_pcie0<span class="o">]</span><span class="w"> </span>NOT<span class="w"> </span>using<span class="w"> </span>DMA<span class="w"> </span>to<span class="w"> </span>transfer<span class="w"> </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span>host<span class="w"> </span>to<span class="w"> </span>device<span class="w"> </span>because<span class="w"> </span>of<span class="w"> </span>lack<span class="w"> </span>of<span class="w"> </span>alignment
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>**<span class="w">                 </span>host<span class="w"> </span>ptr<span class="w"> </span><span class="o">(</span>0xb611910<span class="o">)</span><span class="w"> </span>and/or<span class="w"> </span>dev<span class="w"> </span>offset<span class="w"> </span><span class="o">(</span>0x800<span class="o">)</span><span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>aligned<span class="w"> </span>to<span class="w"> </span><span class="m">64</span><span class="w"> </span>bytes
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>**<span class="w"> </span>WARNING:<span class="w"> </span><span class="o">[</span>aclbitt_s10mx_pcie0<span class="o">]</span><span class="w"> </span>NOT<span class="w"> </span>using<span class="w"> </span>DMA<span class="w"> </span>to<span class="w"> </span>transfer<span class="w"> </span><span class="m">1024</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span>device<span class="w"> </span>to<span class="w"> </span>host<span class="w"> </span>because<span class="w"> </span>of<span class="w"> </span>lack<span class="w"> </span>of<span class="w"> </span>alignment
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>**<span class="w">                 </span>host<span class="w"> </span>ptr<span class="w"> </span><span class="o">(</span>0xb611d20<span class="o">)</span><span class="w"> </span>and/or<span class="w"> </span>dev<span class="w"> </span>offset<span class="w"> </span><span class="o">(</span>0xc00<span class="o">)</span><span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>aligned<span class="w"> </span>to<span class="w"> </span><span class="m">64</span><span class="w"> </span>bytes
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>PASSED
</span></code></pre></div>
Replace the following lines:
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span></code></pre></div>
by these ones:
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">align_val_t</span><span class="p">{</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">align_val_t</span><span class="p">{</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">align_val_t</span><span class="p">{</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span><span class="w"> </span>
</span></code></pre></div></p>
</div>
</div>
</div>
</div>
<h2 id="queue">Queue<a class="headerlink" href="#queue" title="Permanent link">&para;</a></h2>
<p>Contrary to OpenCL, queues in SYCL are out-of-order by default. Nonetheless, you can change this behavior you declare it in your code.</p>
<div class="admonition example">
<p class="admonition-title">In-order-queue</p>
<p><div style="width: 70%; float: left">
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="w">  </span><span class="p">...</span><span class="w"> </span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">  </span><span class="n">queue</span><span class="w"> </span><span class="n">device_queue</span><span class="p">{</span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_selector_v</span><span class="p">,{</span><span class="n">property</span><span class="o">::</span><span class="n">queue</span><span class="o">::</span><span class="n">in_order</span><span class="p">()}};</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">  </span><span class="c1">// Task A</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w">  </span><span class="n">device_queue</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="o">&amp;</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">TaskA</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w">  </span><span class="p">});</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">  </span><span class="c1">// Task B</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">  </span><span class="n">device_queue</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="o">&amp;</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">TaskB</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">  </span><span class="p">});</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">  </span><span class="c1">// Task C</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">  </span><span class="n">device_queue</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="o">&amp;</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">TaskC</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">  </span><span class="p">});</span><span class="w"> </span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">  </span><span class="p">...</span>
</span></code></pre></div>
</div>
<div style="width: 20%; float: right">
<pre class="mermaid"><code>graph TD
A[TaskA] --&gt; B[TaskB];
B[TaskB] --&gt; C[TaskC];</code></pre>
</div></p>
</div>
<p>This behavior is not very useful nor flexible. Queue objects, by default, are out-of-order queues, except when they're constructed with the in-order queue property. Because of this, they must include mechanisms to arrange tasks that are sent to them. The way queues organize tasks is by allowing the user to notify the runtime about the dependencies that exist between these tasks. These dependencies can be described in two ways: either explicitly or implicitly, through the use of command groups.</p>
<p>A command group is a specific object that outlines a task and its dependencies. These groups are generally expressed as C++ lambdas and are handed over as arguments to the submit() method within a queue object. The single parameter within this lambda is a reference to a handler object, utilized inside the command group to define actions, generate accessors, and outline dependencies.</p>
<h3 id="explicit-dependencies">Explicit dependencies<a class="headerlink" href="#explicit-dependencies" title="Permanent link">&para;</a></h3>
<p>Like for OpenCL, you can manage dependencies explicitly using events. </p>
<div class="admonition example">
<p class="admonition-title">Using events</p>
<p><div style="width: 75%; float: left">
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="w">  </span><span class="p">...</span><span class="w"> </span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="n">queue</span><span class="w"> </span><span class="n">device_queue</span><span class="p">{</span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_selector_v</span><span class="p">};</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">  </span><span class="c1">// Task A</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">event_A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_queue</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">TaskA</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">  </span><span class="p">});</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">  </span><span class="n">event_A</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">  </span><span class="c1">// Task B</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">event_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_queue</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">TaskB</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">  </span><span class="p">});</span>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">  </span><span class="c1">// Task C</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">event_C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">device_queue</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">TaskC</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">  </span><span class="p">});</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">  </span><span class="c1">// Task D</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">  </span><span class="n">device_queue</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="w">  </span><span class="n">h</span><span class="p">.</span><span class="n">depends_on</span><span class="p">({</span><span class="n">event_B</span><span class="p">,</span><span class="w"> </span><span class="n">event_C</span><span class="p">});</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">  </span><span class="n">h</span><span class="p">.</span><span class="n">parallel_for</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">id</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/*...*/</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">  </span><span class="p">}).</span><span class="n">wait</span><span class="p">();</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">  </span><span class="p">...</span>
</span></code></pre></div>
</div>
<div style="width: 25%; float: right">
<pre class="mermaid"><code>graph TD
A[TaskA] --&gt; B[TaskB];
A[TaskA] --&gt; C[TaskC];
B[TaskB] --&gt; D[TaskD];
C[TaskC] --&gt; D[TaskD];</code></pre>
</div></p>
</div>
<ul>
<li>Explicit dependencies using events is relevant when you use USM since buffers make use of accessors to model data dependencies.</li>
<li>They are three possibilities to declare a dependcies explicitely:</li>
<li>Calling the method <code>wait()</code> on the queue it-self</li>
<li>Calling the method <code>wait</code> on the event return by the queue after submitting a command</li>
<li>Calling the method <code>depends_on</code> of the handler object</li>
</ul>
<h3 id="implicit-dependencies">Implicit dependencies<a class="headerlink" href="#implicit-dependencies" title="Permanent link">&para;</a></h3>
<ul>
<li>Implicit dependencies occurs when your are using buffer &amp; accessor.</li>
<li>
<p>Accessors have different access modes:</p>
</li>
<li>
<p><strong>read_only</strong>: The content of the buffer can only be accessed for reading. So the content will only be copied once to the device</p>
</li>
<li><strong>write_only</strong>: The content of the buffer can only be accessed for writing. The content of buffer is still copied from host to device before the kernel starts </li>
<li><strong>read_write</strong>: The content of the buffer can be accessed for reading and writing.</li>
</ul>
<p>You can add the <code>no_init</code> property to an accessor in <code>write_only</code> mode. This tells the runtime that the original data contains in the buffer can be ignored and don't need to be copied from host to device.</p>
<p>Implicit dependencies obey to three main patterns (see <a href="https://link.springer.com/book/10.1007/978-1-4842-5574-2">DPC++ book</a>):</p>
<ul>
<li><strong>Read-after-Write  (RAW)</strong> : occurs when some data modified by a kernel should be read by another kernel. </li>
<li><strong>Write-after-Read  (WAR)</strong> : occurs when some data read by a kernel will be modified by another one</li>
<li><strong>Write-after-Write (WAW)</strong> : occurs when two kernels modified the same data</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Implicit dependencies</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Question</label><label for="__tabbed_3_2">Solution</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ul>
<li>By default without access mode, each accessor will be read_write inducing unnecessary copies.</li>
<li>Note also the first use of <code>host_accessor</code>. Why did we use it here ?</li>
<li>Modifiy the following code to take into account implicit dependencies.
 <div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span>
<span class="normal"><a href="#__codelineno-8-11">11</a></span>
<span class="normal"><a href="#__codelineno-8-12">12</a></span>
<span class="normal"><a href="#__codelineno-8-13">13</a></span>
<span class="normal"><a href="#__codelineno-8-14">14</a></span>
<span class="normal"><a href="#__codelineno-8-15">15</a></span>
<span class="normal"><a href="#__codelineno-8-16">16</a></span>
<span class="normal"><a href="#__codelineno-8-17">17</a></span>
<span class="normal"><a href="#__codelineno-8-18">18</a></span>
<span class="normal"><a href="#__codelineno-8-19">19</a></span>
<span class="normal"><a href="#__codelineno-8-20">20</a></span>
<span class="normal"><a href="#__codelineno-8-21">21</a></span>
<span class="normal"><a href="#__codelineno-8-22">22</a></span>
<span class="normal"><a href="#__codelineno-8-23">23</a></span>
<span class="normal"><a href="#__codelineno-8-24">24</a></span>
<span class="normal"><a href="#__codelineno-8-25">25</a></span>
<span class="normal"><a href="#__codelineno-8-26">26</a></span>
<span class="normal"><a href="#__codelineno-8-27">27</a></span>
<span class="normal"><a href="#__codelineno-8-28">28</a></span>
<span class="normal"><a href="#__codelineno-8-29">29</a></span>
<span class="normal"><a href="#__codelineno-8-30">30</a></span>
<span class="normal"><a href="#__codelineno-8-31">31</a></span>
<span class="normal"><a href="#__codelineno-8-32">32</a></span>
<span class="normal"><a href="#__codelineno-8-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="w">   </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">   </span><span class="n">queue</span><span class="w"> </span><span class="n">Q</span><span class="p">;</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">   </span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">A</span><span class="p">{</span><span class="n">range</span><span class="p">{</span><span class="n">N</span><span class="p">}};</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">   </span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">{</span><span class="n">range</span><span class="p">{</span><span class="n">N</span><span class="p">}};</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">   </span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">C</span><span class="p">{</span><span class="n">range</span><span class="p">{</span><span class="n">N</span><span class="p">}};</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">   </span><span class="n">Q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">      </span><span class="n">accessor</span><span class="w"> </span><span class="n">aA</span><span class="p">{</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">      </span><span class="n">accessor</span><span class="w"> </span><span class="n">aB</span><span class="p">{</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">      </span><span class="n">accessor</span><span class="w"> </span><span class="n">aC</span><span class="p">{</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">      </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">Kernel1</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">             </span><span class="n">aA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">             </span><span class="n">aB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">             </span><span class="n">aC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">      </span><span class="p">});</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">   </span><span class="p">});</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">   </span><span class="n">Q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">       </span><span class="n">accessor</span><span class="w"> </span><span class="n">aA</span><span class="p">{</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">       </span><span class="n">accessor</span><span class="w"> </span><span class="n">aB</span><span class="p">{</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="w">       </span><span class="n">accessor</span><span class="w"> </span><span class="n">aC</span><span class="p">{</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">       </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">Kernel2</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">             </span><span class="n">aC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">aB</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">   </span><span class="p">});</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">   </span><span class="n">Q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="w">       </span><span class="n">accessor</span><span class="w"> </span><span class="n">aC</span><span class="p">{</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="w">       </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">Kernel3</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29"></a><span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30"></a><span class="w">            </span><span class="n">aC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31"></a><span class="w">       </span><span class="p">});</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32"></a><span class="w">   </span><span class="p">});</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33"></a><span class="w">   </span><span class="n">host_accessor</span><span class="w"> </span><span class="n">result</span><span class="p">{</span><span class="n">C</span><span class="p">};</span>
</span></code></pre></div></td></tr></table></div></li>
</ul>
</div>
<div class="tabbed-block">
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span>
<span class="normal"><a href="#__codelineno-9-19">19</a></span>
<span class="normal"><a href="#__codelineno-9-20">20</a></span>
<span class="normal"><a href="#__codelineno-9-21">21</a></span>
<span class="normal"><a href="#__codelineno-9-22">22</a></span>
<span class="normal"><a href="#__codelineno-9-23">23</a></span>
<span class="normal"><a href="#__codelineno-9-24">24</a></span>
<span class="normal"><a href="#__codelineno-9-25">25</a></span>
<span class="normal"><a href="#__codelineno-9-26">26</a></span>
<span class="normal"><a href="#__codelineno-9-27">27</a></span>
<span class="normal"><a href="#__codelineno-9-28">28</a></span>
<span class="normal"><a href="#__codelineno-9-29">29</a></span>
<span class="normal"><a href="#__codelineno-9-30">30</a></span>
<span class="normal"><a href="#__codelineno-9-31">31</a></span>
<span class="normal"><a href="#__codelineno-9-32">32</a></span>
<span class="normal"><a href="#__codelineno-9-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="w">   </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">   </span><span class="n">queue</span><span class="w"> </span><span class="n">Q</span><span class="p">;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">   </span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">A</span><span class="p">{</span><span class="n">range</span><span class="p">{</span><span class="n">N</span><span class="p">}};</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">   </span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">B</span><span class="p">{</span><span class="n">range</span><span class="p">{</span><span class="n">N</span><span class="p">}};</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">   </span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">C</span><span class="p">{</span><span class="n">range</span><span class="p">{</span><span class="n">N</span><span class="p">}};</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">   </span><span class="n">Q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">      </span><span class="n">accessor</span><span class="w"> </span><span class="n">aA</span><span class="p">{</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">write_only</span><span class="p">,</span><span class="w"> </span><span class="n">no_init</span><span class="p">};</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">      </span><span class="n">accessor</span><span class="w"> </span><span class="n">aB</span><span class="p">{</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">write_only</span><span class="p">,</span><span class="w"> </span><span class="n">no_init</span><span class="p">};</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">      </span><span class="n">accessor</span><span class="w"> </span><span class="n">aC</span><span class="p">{</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">write_only</span><span class="p">,</span><span class="w"> </span><span class="n">no_init</span><span class="p">};</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">      </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">Kernel1</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">             </span><span class="n">aA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">             </span><span class="n">aB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">50</span><span class="p">;</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">             </span><span class="n">aC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">      </span><span class="p">});</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">   </span><span class="p">});</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">   </span><span class="n">Q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">       </span><span class="n">accessor</span><span class="w"> </span><span class="n">aA</span><span class="p">{</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">       </span><span class="n">accessor</span><span class="w"> </span><span class="n">aB</span><span class="p">{</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">       </span><span class="n">accessor</span><span class="w"> </span><span class="n">aC</span><span class="p">{</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">write_only</span><span class="p">};</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">       </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">Kernel2</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
</span><span id="__span-9-22"><a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">          </span><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-9-23"><a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">             </span><span class="n">aC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">aA</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">aB</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span>
</span><span id="__span-9-24"><a id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-9-25"><a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">   </span><span class="p">});</span>
</span><span id="__span-9-26"><a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">   </span><span class="n">Q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-27"><a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">       </span><span class="n">accessor</span><span class="w"> </span><span class="n">aC</span><span class="p">{</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">write_only</span><span class="p">};</span>
</span><span id="__span-9-28"><a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">       </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">Kernel3</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-29"><a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span id="__span-9-30"><a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">            </span><span class="n">aC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-9-31"><a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">       </span><span class="p">});</span>
</span><span id="__span-9-32"><a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">   </span><span class="p">});</span>
</span><span id="__span-9-33"><a id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">   </span><span class="n">host_accessor</span><span class="w"> </span><span class="n">result</span><span class="p">{</span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">read_only</span><span class="p">};</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<h2 id="parallelism-model-for-fpga">Parallelism model for FPGA<a class="headerlink" href="#parallelism-model-for-fpga" title="Permanent link">&para;</a></h2>
<ul>
<li>FPGA strongly differs from ISA-based hardware such as CPU and GPU</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Difference between <strong>Instruction Set</strong> architecture and <strong>Spatial</strong> architecture</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Instruction Set Architecture</label><label for="__tabbed_4_2">Spatial Architecture</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ul>
<li>Made for general-purpose computation: hardware is constantly reused </li>
<li>Workflow constrained by a set of pre-defined units (Control Units, ALUs, registers)</li>
<li>Data/Register size are fixed</li>
<li>Different instruction executed in each clock cycle : <strong>temporal</strong> execution<br />
<img alt="" src="../images/isa.png" /></li>
</ul>
</div>
<div class="tabbed-block">
<ul>
<li>Keep only what it needs -- the hardware can be reconfigured</li>
<li>Specialize the everything by unrolling the hardware: <strong>spatial</strong> execution</li>
<li>Each operation uses a different hardware region</li>
<li>The design can take more space than the FPGA offers </li>
</ul>
<p><img alt="" src="../images/spatial_arch.png" width="90%" /></p>
</div>
</div>
</div>
</div>
<ul>
<li>
<p>The most obvious source of <strong>parallelism</strong> for FPGA is <strong>pipelining</strong> by inserting registers to store each operation output and keep all hardware unit busy. </p>
</li>
<li>
<p>Pipelining parallelism has therefore many stages. </p>
</li>
<li>
<p>If you don't have enough work to fill the pipeline, then the efficiency is very low.</p>
</li>
<li>
<p>The authors of the <a href="https://link.springer.com/book/10.1007/978-1-4842-5574-2">DPC++ book</a> have illustrated it perfectly in Chapter 17.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Pipelining example provided chap.17 (DPC++ book)</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Processing a single element (Figure. 17-13)</label><label for="__tabbed_5_2">Taking advantage of pipelining (Figure 17-14)</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><img alt="" src="../images/single.png" /></p>
<ul>
<li>The pipeline is mostly empty.</li>
<li>Hardware units are not busy and the efficiency is thus low.</li>
</ul>
</div>
<div class="tabbed-block">
<p><img alt="" src="../images/multiple.png" /></p>
<ul>
<li>More data than stages, the pipeline is full and all hardware units are busy.</li>
</ul>
</div>
</div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Vectorization</p>
<p>Vectorization is not the main source of parallelism but help designing efficient pipeline. Since hardware can be reconfigured at will. The offline compiler can design N-bits Adders, multipliers which simplify greatly vectorization. In fact, the offline compiler vectorizes your design automatically if possible.</p>
</div>
<h3 id="pipelining-with-nd-range-kernels">Pipelining with ND-range kernels<a class="headerlink" href="#pipelining-with-nd-range-kernels" title="Permanent link">&para;</a></h3>
<ul>
<li>ND-range kernels are based on a hierachical grouping of work-items</li>
<li>A work-item represents a single unit of work </li>
<li>Independent simple units of work don't communicate or share data very often</li>
<li>Useful when porting a GPU kernel to FPGA</li>
</ul>
<figure>
<p><img alt="" src="../images/ndrange.png" /> 
  </p>
<figcaption><a href=https://link.springer.com/book/10.1007/978-1-4842-5574-2>DPC++ book</a> -- Figure 17-15 </figcaption>
</figure>
<ul>
<li>FPGAs are different from GPU (lots of thread started at the same time)</li>
<li>Impossible to replicate a hardware for a million of work-items</li>
<li>Work-items are injected into the pipeline</li>
<li>A deep pipeline means lots of work-items executing different tasks in parallel</li>
</ul>
<figure>
<p><img alt="" src="../images/ndrange_pipeline.png" />
  </p>
<figcaption><a href=https://link.springer.com/book/10.1007/978-1-4842-5574-2>DPC++ book</a> -- Figure 17-16 </figcaption>
</figure>
<ul>
<li>In order to write basic data-parallel kernel, you will need to use the <code>parallel_for</code> method. Below is an example of simple data-parallel kernel. As you can notice it, there is no notion of groups nor sub-groups. </li>
</ul>
<div class="admonition example">
<p class="admonition-title">Matrix addition</p>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="w">   </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2048</span><span class="p">;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">   </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">   </span><span class="n">queue</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">     </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">acc_a</span><span class="p">{</span><span class="n">buffer_a</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">     </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">acc_b</span><span class="p">{</span><span class="n">buffer_b</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">     </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">acc_c</span><span class="p">{</span><span class="n">buffer_c</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_write</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">no_init</span><span class="p">};</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">     </span><span class="n">h</span><span class="p">.</span><span class="n">parallel_for</span><span class="p">(</span><span class="n">range</span><span class="p">{</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">id</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">      </span><span class="n">acc_c</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">acc_a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">acc_b</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">     </span><span class="p">});</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">   </span><span class="p">});</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Vector addition</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Question</label><label for="__tabbed_6_2">Solution</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ul>
<li>Go to the <code>GettingStarted/fpga_compile/part4_dpcpp_lambda_buffers/src</code></li>
<li>Adapt the <code>vector_add.cpp</code> single-task kernel to a basis data-parallel kernel</li>
<li>Emulate to verify your design</li>
</ul>
</div>
<div class="tabbed-block">
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span>
<span class="normal"><a href="#__codelineno-11-43">43</a></span>
<span class="normal"><a href="#__codelineno-11-44">44</a></span>
<span class="normal"><a href="#__codelineno-11-45">45</a></span>
<span class="normal"><a href="#__codelineno-11-46">46</a></span>
<span class="normal"><a href="#__codelineno-11-47">47</a></span>
<span class="normal"><a href="#__codelineno-11-48">48</a></span>
<span class="normal"><a href="#__codelineno-11-49">49</a></span>
<span class="normal"><a href="#__codelineno-11-50">50</a></span>
<span class="normal"><a href="#__codelineno-11-51">51</a></span>
<span class="normal"><a href="#__codelineno-11-52">52</a></span>
<span class="normal"><a href="#__codelineno-11-53">53</a></span>
<span class="normal"><a href="#__codelineno-11-54">54</a></span>
<span class="normal"><a href="#__codelineno-11-55">55</a></span>
<span class="normal"><a href="#__codelineno-11-56">56</a></span>
<span class="normal"><a href="#__codelineno-11-57">57</a></span>
<span class="normal"><a href="#__codelineno-11-58">58</a></span>
<span class="normal"><a href="#__codelineno-11-59">59</a></span>
<span class="normal"><a href="#__codelineno-11-60">60</a></span>
<span class="normal"><a href="#__codelineno-11-61">61</a></span>
<span class="normal"><a href="#__codelineno-11-62">62</a></span>
<span class="normal"><a href="#__codelineno-11-63">63</a></span>
<span class="normal"><a href="#__codelineno-11-64">64</a></span>
<span class="normal"><a href="#__codelineno-11-65">65</a></span>
<span class="normal"><a href="#__codelineno-11-66">66</a></span>
<span class="normal"><a href="#__codelineno-11-67">67</a></span>
<span class="normal"><a href="#__codelineno-11-68">68</a></span>
<span class="normal"><a href="#__codelineno-11-69">69</a></span>
<span class="normal"><a href="#__codelineno-11-70">70</a></span>
<span class="normal"><a href="#__codelineno-11-71">71</a></span>
<span class="normal"><a href="#__codelineno-11-72">72</a></span>
<span class="normal"><a href="#__codelineno-11-73">73</a></span>
<span class="normal"><a href="#__codelineno-11-74">74</a></span>
<span class="normal"><a href="#__codelineno-11-75">75</a></span>
<span class="normal"><a href="#__codelineno-11-76">76</a></span>
<span class="normal"><a href="#__codelineno-11-77">77</a></span>
<span class="normal"><a href="#__codelineno-11-78">78</a></span>
<span class="normal"><a href="#__codelineno-11-79">79</a></span>
<span class="normal"><a href="#__codelineno-11-80">80</a></span>
<span class="normal"><a href="#__codelineno-11-81">81</a></span>
<span class="normal"><a href="#__codelineno-11-82">82</a></span>
<span class="normal"><a href="#__codelineno-11-83">83</a></span>
<span class="normal"><a href="#__codelineno-11-84">84</a></span>
<span class="normal"><a href="#__codelineno-11-85">85</a></span>
<span class="normal"><a href="#__codelineno-11-86">86</a></span>
<span class="normal"><a href="#__codelineno-11-87">87</a></span>
<span class="normal"><a href="#__codelineno-11-88">88</a></span>
<span class="normal"><a href="#__codelineno-11-89">89</a></span>
<span class="normal"><a href="#__codelineno-11-90">90</a></span>
<span class="normal"><a href="#__codelineno-11-91">91</a></span>
<span class="normal"><a href="#__codelineno-11-92">92</a></span>
<span class="normal"><a href="#__codelineno-11-93">93</a></span>
<span class="normal"><a href="#__codelineno-11-94">94</a></span>
<span class="normal"><a href="#__codelineno-11-95">95</a></span>
<span class="normal"><a href="#__codelineno-11-96">96</a></span>
<span class="normal"><a href="#__codelineno-11-97">97</a></span>
<span class="normal"><a href="#__codelineno-11-98">98</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="c1">// oneAPI headers</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/ext/intel/fpga_extensions.hpp&gt;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="c1">// Forward declare the kernel name in the global scope. This is an FPGA best</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="c1">// practice that reduces name mangling in the optimization reports.</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">VectorAddID</span><span class="p">;</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="kt">bool</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">    </span><span class="c1">// Use compile-time macros to select either:</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span><span class="c1">//  - the FPGA emulator device (CPU emulation of the FPGA)</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span><span class="c1">//  - the FPGA device (a real FPGA)</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span><span class="c1">//  - the simulator device</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="cp">#if FPGA_SIMULATOR</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_simulator_selector_v</span><span class="p">;</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="w">    </span><span class="cp">#elif FPGA_HARDWARE</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_selector_v</span><span class="p">;</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="w">    </span><span class="cp">#else  </span><span class="c1">// #if FPGA_EMULATOR</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_emulator_selector_v</span><span class="p">;</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="w">    </span><span class="cp">#endif</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26"></a>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="w">    </span><span class="c1">// create the device queue</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="w">    </span><span class="n">sycl</span><span class="o">::</span><span class="n">queue</span><span class="w"> </span><span class="n">q</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29"></a>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">    </span><span class="c1">// make sure the device supports USM host allocations</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">get_device</span><span class="p">();</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32"></a>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Running on device: &quot;</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="n">get_info</span><span class="o">&lt;</span><span class="n">sycl</span><span class="o">::</span><span class="n">info</span><span class="o">::</span><span class="n">device</span><span class="o">::</span><span class="n">name</span><span class="o">&gt;</span><span class="p">().</span><span class="n">c_str</span><span class="p">()</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36"></a>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37"></a><span class="w">    </span><span class="c1">// declare arrays and fill them</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">align_val_t</span><span class="p">{</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">align_val_t</span><span class="p">{</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">align_val_t</span><span class="p">{</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="kt">int</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42"></a><span class="w">      </span><span class="n">vec_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43"></a><span class="w">      </span><span class="n">vec_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">kVectSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45"></a>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;add two vectors of size &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48"></a><span class="w">      </span><span class="c1">// copy the input arrays to buffers to share with kernel</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="w"> </span><span class="n">buffer_a</span><span class="p">{</span><span class="n">vec_a</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="p">(</span><span class="n">kVectSize</span><span class="p">)};</span>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="w"> </span><span class="n">buffer_b</span><span class="p">{</span><span class="n">vec_b</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="p">(</span><span class="n">kVectSize</span><span class="p">)};</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="w"> </span><span class="n">buffer_c</span><span class="p">{</span><span class="n">vec_c</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="p">(</span><span class="n">kVectSize</span><span class="p">)};</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52"></a>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53"></a><span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54"></a><span class="w">        </span><span class="c1">// use accessors to interact with buffers from device code</span>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">accessor_a</span><span class="p">{</span><span class="n">buffer_a</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">accessor_b</span><span class="p">{</span><span class="n">buffer_b</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">accessor_c</span><span class="p">{</span><span class="n">buffer_c</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">write_only</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">no_init</span><span class="p">};</span>
</span><span id="__span-11-58"><a id="__codelineno-11-58" name="__codelineno-11-58"></a>
</span><span id="__span-11-59"><a id="__codelineno-11-59" name="__codelineno-11-59"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">parallel_for</span><span class="o">&lt;</span><span class="n">VectorAddID</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="p">(</span><span class="n">kVectSize</span><span class="p">),[</span><span class="o">=</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">id</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-60"><a id="__codelineno-11-60" name="__codelineno-11-60"></a><span class="w">      </span><span class="n">accessor_c</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accessor_a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">accessor_b</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
</span><span id="__span-11-61"><a id="__codelineno-11-61" name="__codelineno-11-61"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-11-62"><a id="__codelineno-11-62" name="__codelineno-11-62"></a><span class="w">      </span><span class="p">});</span>
</span><span id="__span-11-63"><a id="__codelineno-11-63" name="__codelineno-11-63"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-64"><a id="__codelineno-11-64" name="__codelineno-11-64"></a><span class="w">    </span><span class="c1">// result is copied back to host automatically when accessors go out of</span>
</span><span id="__span-11-65"><a id="__codelineno-11-65" name="__codelineno-11-65"></a><span class="w">    </span><span class="c1">// scope.</span>
</span><span id="__span-11-66"><a id="__codelineno-11-66" name="__codelineno-11-66"></a>
</span><span id="__span-11-67"><a id="__codelineno-11-67" name="__codelineno-11-67"></a><span class="w">    </span><span class="c1">// verify that VC is correct</span>
</span><span id="__span-11-68"><a id="__codelineno-11-68" name="__codelineno-11-68"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-69"><a id="__codelineno-11-69" name="__codelineno-11-69"></a><span class="w">      </span><span class="kt">int</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vec_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">vec_b</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-11-70"><a id="__codelineno-11-70" name="__codelineno-11-70"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-71"><a id="__codelineno-11-71" name="__codelineno-11-71"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;idx=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;: result &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vec_c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, expected (&quot;</span>
</span><span id="__span-11-72"><a id="__codelineno-11-72" name="__codelineno-11-72"></a><span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;) A=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vec_a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; + B=&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">vec_b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="__span-11-73"><a id="__codelineno-11-73" name="__codelineno-11-73"></a><span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-11-74"><a id="__codelineno-11-74" name="__codelineno-11-74"></a><span class="w">        </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-11-75"><a id="__codelineno-11-75" name="__codelineno-11-75"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-11-76"><a id="__codelineno-11-76" name="__codelineno-11-76"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-77"><a id="__codelineno-11-77" name="__codelineno-11-77"></a>
</span><span id="__span-11-78"><a id="__codelineno-11-78" name="__codelineno-11-78"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;PASSED&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;FAILED&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-11-79"><a id="__codelineno-11-79" name="__codelineno-11-79"></a>
</span><span id="__span-11-80"><a id="__codelineno-11-80" name="__codelineno-11-80"></a><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">vec_a</span><span class="p">;</span>
</span><span id="__span-11-81"><a id="__codelineno-11-81" name="__codelineno-11-81"></a><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">vec_b</span><span class="p">;</span>
</span><span id="__span-11-82"><a id="__codelineno-11-82" name="__codelineno-11-82"></a><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">vec_c</span><span class="p">;</span>
</span><span id="__span-11-83"><a id="__codelineno-11-83" name="__codelineno-11-83"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-84"><a id="__codelineno-11-84" name="__codelineno-11-84"></a><span class="w">    </span><span class="c1">// Catches exceptions in the host code.</span>
</span><span id="__span-11-85"><a id="__codelineno-11-85" name="__codelineno-11-85"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Caught a SYCL host exception:</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-11-86"><a id="__codelineno-11-86" name="__codelineno-11-86"></a>
</span><span id="__span-11-87"><a id="__codelineno-11-87" name="__codelineno-11-87"></a><span class="w">    </span><span class="c1">// Most likely the runtime couldn&#39;t find FPGA hardware!</span>
</span><span id="__span-11-88"><a id="__codelineno-11-88" name="__codelineno-11-88"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">code</span><span class="p">().</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CL_DEVICE_NOT_FOUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-89"><a id="__codelineno-11-89" name="__codelineno-11-89"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting an FPGA, please ensure that your &quot;</span>
</span><span id="__span-11-90"><a id="__codelineno-11-90" name="__codelineno-11-90"></a><span class="w">                   </span><span class="s">&quot;system has a correctly configured FPGA board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-11-91"><a id="__codelineno-11-91" name="__codelineno-11-91"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Run sys_check in the oneAPI root directory to verify.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-11-92"><a id="__codelineno-11-92" name="__codelineno-11-92"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting the FPGA emulator, compile with &quot;</span>
</span><span id="__span-11-93"><a id="__codelineno-11-93" name="__codelineno-11-93"></a><span class="w">                   </span><span class="s">&quot;-DFPGA_EMULATOR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-11-94"><a id="__codelineno-11-94" name="__codelineno-11-94"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-95"><a id="__codelineno-11-95" name="__codelineno-11-95"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">terminate</span><span class="p">();</span>
</span><span id="__span-11-96"><a id="__codelineno-11-96" name="__codelineno-11-96"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-11-97"><a id="__codelineno-11-97" name="__codelineno-11-97"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
</span><span id="__span-11-98"><a id="__codelineno-11-98" name="__codelineno-11-98"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<ul>
<li>If you want to have a fine-grained control of your data-parallel kernel, ND-range data-parallel kernels are the equivalent of ND-range kernels in OpenCL. </li>
</ul>
<div class="admonition success">
<p class="admonition-title">ND-range kernel in SYCL</p>
<ul>
<li><code>nd_range(range&lt;dimensions&gt; globalSize, range&lt;dimensions&gt; localSize);</code></li>
<li>ND-range kernels are defined with two range objects<ul>
<li><strong>global</strong> representing the total size of work-items</li>
<li><strong>local</strong> representing the size of work-groups</li>
</ul>
</li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">Tiled Matrix Multiplication</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">Question</label><label for="__tabbed_7_2">Solution</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ul>
<li>Fill the blank and complete the code
 <div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">  1</a></span>
<span class="normal"><a href="#__codelineno-12-2">  2</a></span>
<span class="normal"><a href="#__codelineno-12-3">  3</a></span>
<span class="normal"><a href="#__codelineno-12-4">  4</a></span>
<span class="normal"><a href="#__codelineno-12-5">  5</a></span>
<span class="normal"><a href="#__codelineno-12-6">  6</a></span>
<span class="normal"><a href="#__codelineno-12-7">  7</a></span>
<span class="normal"><a href="#__codelineno-12-8">  8</a></span>
<span class="normal"><a href="#__codelineno-12-9">  9</a></span>
<span class="normal"><a href="#__codelineno-12-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-12-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-12-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-12-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-12-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-12-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-12-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-12-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-12-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-12-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-12-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-12-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-12-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-12-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-12-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-12-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-12-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-12-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-12-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-12-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-12-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-12-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-12-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-12-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-12-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-12-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-12-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-12-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-12-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-12-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-12-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-12-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-12-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-12-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-12-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-12-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-12-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-12-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-12-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-12-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-12-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-12-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-12-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-12-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-12-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-12-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-12-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-12-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-12-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-12-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-12-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-12-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-12-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-12-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-12-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-12-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-12-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-12-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-12-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-12-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-12-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-12-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-12-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-12-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-12-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-12-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-12-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-12-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-12-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-12-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-12-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-12-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-12-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-12-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-12-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-12-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-12-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-12-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-12-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-12-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-12-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-12-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-12-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-12-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-12-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-12-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-12-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-12-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-12-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-12-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-12-100">100</a></span>
<span class="normal"><a href="#__codelineno-12-101">101</a></span>
<span class="normal"><a href="#__codelineno-12-102">102</a></span>
<span class="normal"><a href="#__codelineno-12-103">103</a></span>
<span class="normal"><a href="#__codelineno-12-104">104</a></span>
<span class="normal"><a href="#__codelineno-12-105">105</a></span>
<span class="normal"><a href="#__codelineno-12-106">106</a></span>
<span class="normal"><a href="#__codelineno-12-107">107</a></span>
<span class="normal"><a href="#__codelineno-12-108">108</a></span>
<span class="normal"><a href="#__codelineno-12-109">109</a></span>
<span class="normal"><a href="#__codelineno-12-110">110</a></span>
<span class="normal"><a href="#__codelineno-12-111">111</a></span>
<span class="normal"><a href="#__codelineno-12-112">112</a></span>
<span class="normal"><a href="#__codelineno-12-113">113</a></span>
<span class="normal"><a href="#__codelineno-12-114">114</a></span>
<span class="normal"><a href="#__codelineno-12-115">115</a></span>
<span class="normal"><a href="#__codelineno-12-116">116</a></span>
<span class="normal"><a href="#__codelineno-12-117">117</a></span>
<span class="normal"><a href="#__codelineno-12-118">118</a></span>
<span class="normal"><a href="#__codelineno-12-119">119</a></span>
<span class="normal"><a href="#__codelineno-12-120">120</a></span>
<span class="normal"><a href="#__codelineno-12-121">121</a></span>
<span class="normal"><a href="#__codelineno-12-122">122</a></span>
<span class="normal"><a href="#__codelineno-12-123">123</a></span>
<span class="normal"><a href="#__codelineno-12-124">124</a></span>
<span class="normal"><a href="#__codelineno-12-125">125</a></span>
<span class="normal"><a href="#__codelineno-12-126">126</a></span>
<span class="normal"><a href="#__codelineno-12-127">127</a></span>
<span class="normal"><a href="#__codelineno-12-128">128</a></span>
<span class="normal"><a href="#__codelineno-12-129">129</a></span>
<span class="normal"><a href="#__codelineno-12-130">130</a></span>
<span class="normal"><a href="#__codelineno-12-131">131</a></span>
<span class="normal"><a href="#__codelineno-12-132">132</a></span>
<span class="normal"><a href="#__codelineno-12-133">133</a></span>
<span class="normal"><a href="#__codelineno-12-134">134</a></span>
<span class="normal"><a href="#__codelineno-12-135">135</a></span>
<span class="normal"><a href="#__codelineno-12-136">136</a></span>
<span class="normal"><a href="#__codelineno-12-137">137</a></span>
<span class="normal"><a href="#__codelineno-12-138">138</a></span>
<span class="normal"><a href="#__codelineno-12-139">139</a></span>
<span class="normal"><a href="#__codelineno-12-140">140</a></span>
<span class="normal"><a href="#__codelineno-12-141">141</a></span>
<span class="normal"><a href="#__codelineno-12-142">142</a></span>
<span class="normal"><a href="#__codelineno-12-143">143</a></span>
<span class="normal"><a href="#__codelineno-12-144">144</a></span>
<span class="normal"><a href="#__codelineno-12-145">145</a></span>
<span class="normal"><a href="#__codelineno-12-146">146</a></span>
<span class="normal"><a href="#__codelineno-12-147">147</a></span>
<span class="normal"><a href="#__codelineno-12-148">148</a></span>
<span class="normal"><a href="#__codelineno-12-149">149</a></span>
<span class="normal"><a href="#__codelineno-12-150">150</a></span>
<span class="normal"><a href="#__codelineno-12-151">151</a></span>
<span class="normal"><a href="#__codelineno-12-152">152</a></span>
<span class="normal"><a href="#__codelineno-12-153">153</a></span>
<span class="normal"><a href="#__codelineno-12-154">154</a></span>
<span class="normal"><a href="#__codelineno-12-155">155</a></span>
<span class="normal"><a href="#__codelineno-12-156">156</a></span>
<span class="normal"><a href="#__codelineno-12-157">157</a></span>
<span class="normal"><a href="#__codelineno-12-158">158</a></span>
<span class="normal"><a href="#__codelineno-12-159">159</a></span>
<span class="normal"><a href="#__codelineno-12-160">160</a></span>
<span class="normal"><a href="#__codelineno-12-161">161</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;random&gt;</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="c1">// oneAPI headers</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/ext/intel/fpga_extensions.hpp&gt;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;boost/align/aligned_allocator.hpp&gt;</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="c1">// Forward declare the kernel name in the global scope. This is an FPGA best</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="c1">// practice that reduces name mangling in the optimization reports.</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">MatMultKernel</span><span class="p">;</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">    </span><span class="c1">// Use compile-time macros to select either:</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">    </span><span class="c1">//  - the FPGA emulator device (CPU emulation of the FPGA)</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">    </span><span class="c1">//  - the FPGA device (a real FPGA)</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="w">    </span><span class="c1">//  - the simulator device</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="cp">#if FPGA_SIMULATOR</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_simulator_selector_v</span><span class="p">;</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="cp">#elif FPGA_HARDWARE</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_selector_v</span><span class="p">;</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a><span class="cp">#else  </span><span class="c1">// #if FPGA_EMULATOR</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_emulator_selector_v</span><span class="p">;</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="cp">#endif</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="w">    </span><span class="c1">// create the device queue</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a><span class="w">    </span><span class="n">sycl</span><span class="o">::</span><span class="n">queue</span><span class="w"> </span><span class="n">q</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a><span class="w">    </span><span class="c1">// make sure the device supports USM host allocations</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">get_device</span><span class="p">();</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37"></a>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Running on device: &quot;</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="n">get_info</span><span class="o">&lt;</span><span class="n">sycl</span><span class="o">::</span><span class="n">info</span><span class="o">::</span><span class="n">device</span><span class="o">::</span><span class="n">name</span><span class="o">&gt;</span><span class="p">().</span><span class="n">c_str</span><span class="p">()</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41"></a>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42"></a>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43"></a><span class="w">    </span><span class="c1">// initialize input and output memory on the host</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44"></a><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="p">;</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45"></a><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="n">boost</span><span class="o">::</span><span class="n">alignment</span><span class="o">::</span><span class="n">aligned_allocator</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">64</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">mat_a</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="n">boost</span><span class="o">::</span><span class="n">alignment</span><span class="o">::</span><span class="n">aligned_allocator</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">64</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">mat_b</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="n">boost</span><span class="o">::</span><span class="n">alignment</span><span class="o">::</span><span class="n">aligned_allocator</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">64</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">mat_c</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49"></a>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">random_device</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mt19937</span><span class="w"> </span><span class="n">mt</span><span class="p">(</span><span class="n">rd</span><span class="p">());</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">uniform_real_distribution</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53"></a>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54"></a><span class="w">    </span><span class="c1">// Generate random values</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">generate</span><span class="p">(</span><span class="n">mat_a</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mat_a</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">dist</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mt</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">mt</span><span class="p">);</span>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58"></a>
</span><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59"></a><span class="w">    </span><span class="c1">// Generate random values</span>
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">generate</span><span class="p">(</span><span class="n">mat_b</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mat_b</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">dist</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mt</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-61"><a id="__codelineno-12-61" name="__codelineno-12-61"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">mt</span><span class="p">);</span>
</span><span id="__span-12-62"><a id="__codelineno-12-62" name="__codelineno-12-62"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-12-63"><a id="__codelineno-12-63" name="__codelineno-12-63"></a>
</span><span id="__span-12-64"><a id="__codelineno-12-64" name="__codelineno-12-64"></a><span class="w">    </span><span class="c1">// fill with zero</span>
</span><span id="__span-12-65"><a id="__codelineno-12-65" name="__codelineno-12-65"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">mat_c</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mat_c</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-12-66"><a id="__codelineno-12-66" name="__codelineno-12-66"></a>
</span><span id="__span-12-67"><a id="__codelineno-12-67" name="__codelineno-12-67"></a>
</span><span id="__span-12-68"><a id="__codelineno-12-68" name="__codelineno-12-68"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Matrix multiplication A X B = C &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-12-69"><a id="__codelineno-12-69" name="__codelineno-12-69"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-12-70"><a id="__codelineno-12-70" name="__codelineno-12-70"></a><span class="w">      </span><span class="c1">// copy the input arrays to buffers to share with kernel</span>
</span><span id="__span-12-71"><a id="__codelineno-12-71" name="__codelineno-12-71"></a><span class="w">      </span><span class="c1">// We can access the buffer using mat[i][j]</span>
</span><span id="__span-12-72"><a id="__codelineno-12-72" name="__codelineno-12-72"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer_a</span><span class="p">{</span><span class="n">mat_a</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">)};</span>
</span><span id="__span-12-73"><a id="__codelineno-12-73" name="__codelineno-12-73"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer_b</span><span class="p">{</span><span class="n">mat_b</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">)};</span>
</span><span id="__span-12-74"><a id="__codelineno-12-74" name="__codelineno-12-74"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer_c</span><span class="p">{</span><span class="n">mat_c</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">)};</span>
</span><span id="__span-12-75"><a id="__codelineno-12-75" name="__codelineno-12-75"></a>
</span><span id="__span-12-76"><a id="__codelineno-12-76" name="__codelineno-12-76"></a>
</span><span id="__span-12-77"><a id="__codelineno-12-77" name="__codelineno-12-77"></a><span class="w">      </span><span class="cm">/* DEFINE HERE the global size and local size ranges*/</span>
</span><span id="__span-12-78"><a id="__codelineno-12-78" name="__codelineno-12-78"></a>
</span><span id="__span-12-79"><a id="__codelineno-12-79" name="__codelineno-12-79"></a>
</span><span id="__span-12-80"><a id="__codelineno-12-80" name="__codelineno-12-80"></a><span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-81"><a id="__codelineno-12-81" name="__codelineno-12-81"></a><span class="w">        </span><span class="c1">// use accessors to interact with buffers from device code</span>
</span><span id="__span-12-82"><a id="__codelineno-12-82" name="__codelineno-12-82"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">accessor_a</span><span class="p">{</span><span class="n">buffer_a</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-12-83"><a id="__codelineno-12-83" name="__codelineno-12-83"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">accessor_b</span><span class="p">{</span><span class="n">buffer_b</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-12-84"><a id="__codelineno-12-84" name="__codelineno-12-84"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">accessor_c</span><span class="p">{</span><span class="n">buffer_c</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_write</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">no_init</span><span class="p">};</span>
</span><span id="__span-12-85"><a id="__codelineno-12-85" name="__codelineno-12-85"></a>
</span><span id="__span-12-86"><a id="__codelineno-12-86" name="__codelineno-12-86"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">local_accessor</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tileA</span><span class="p">{{</span><span class="n">B</span><span class="p">,</span><span class="n">B</span><span class="p">},</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-12-87"><a id="__codelineno-12-87" name="__codelineno-12-87"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">local_accessor</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tileB</span><span class="p">{{</span><span class="n">B</span><span class="p">,</span><span class="n">B</span><span class="p">},</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-12-88"><a id="__codelineno-12-88" name="__codelineno-12-88"></a>
</span><span id="__span-12-89"><a id="__codelineno-12-89" name="__codelineno-12-89"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">parallel_for</span><span class="o">&lt;</span><span class="n">MatMultKernel</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">nd_range</span><span class="p">{</span><span class="n">global</span><span class="p">,</span><span class="w"> </span><span class="n">local</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">nd_item</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">)</span>
</span><span id="__span-12-90"><a id="__codelineno-12-90" name="__codelineno-12-90"></a>
</span><span id="__span-12-91"><a id="__codelineno-12-91" name="__codelineno-12-91"></a><span class="w">            </span><span class="p">[[</span><span class="n">intel</span><span class="o">::</span><span class="n">max_work_group_size</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">)]]</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-12-92"><a id="__codelineno-12-92" name="__codelineno-12-92"></a><span class="w">            </span><span class="c1">// Indices in the global index space:</span>
</span><span id="__span-12-93"><a id="__codelineno-12-93" name="__codelineno-12-93"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">get_global_id</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
</span><span id="__span-12-94"><a id="__codelineno-12-94" name="__codelineno-12-94"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">get_global_id</span><span class="p">()[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-12-95"><a id="__codelineno-12-95" name="__codelineno-12-95"></a>
</span><span id="__span-12-96"><a id="__codelineno-12-96" name="__codelineno-12-96"></a><span class="w">            </span><span class="c1">// Index in the local index space:</span>
</span><span id="__span-12-97"><a id="__codelineno-12-97" name="__codelineno-12-97"></a><span class="w">            </span><span class="c1">// Provide local indexes i and j -- fill here</span>
</span><span id="__span-12-98"><a id="__codelineno-12-98" name="__codelineno-12-98"></a>
</span><span id="__span-12-99"><a id="__codelineno-12-99" name="__codelineno-12-99"></a><span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-12-100"><a id="__codelineno-12-100" name="__codelineno-12-100"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">B</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-101"><a id="__codelineno-12-101" name="__codelineno-12-101"></a><span class="w">              </span><span class="c1">// Load the matrix tile from matrix A, and synchronize</span>
</span><span id="__span-12-102"><a id="__codelineno-12-102" name="__codelineno-12-102"></a><span class="w">              </span><span class="c1">// to ensure all work-items have a consistent view</span>
</span><span id="__span-12-103"><a id="__codelineno-12-103" name="__codelineno-12-103"></a><span class="w">              </span><span class="c1">// of the matrix tile in local memory.</span>
</span><span id="__span-12-104"><a id="__codelineno-12-104" name="__codelineno-12-104"></a><span class="w">              </span><span class="n">tileA</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accessor_a</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">p</span><span class="o">*</span><span class="n">B</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-12-105"><a id="__codelineno-12-105" name="__codelineno-12-105"></a><span class="w">              </span><span class="c1">// Do the same for tileB</span>
</span><span id="__span-12-106"><a id="__codelineno-12-106" name="__codelineno-12-106"></a><span class="w">              </span><span class="c1">// fill here </span>
</span><span id="__span-12-107"><a id="__codelineno-12-107" name="__codelineno-12-107"></a><span class="w">              </span><span class="n">item</span><span class="p">.</span><span class="n">barrier</span><span class="p">();</span>
</span><span id="__span-12-108"><a id="__codelineno-12-108" name="__codelineno-12-108"></a>
</span><span id="__span-12-109"><a id="__codelineno-12-109" name="__codelineno-12-109"></a><span class="w">              </span><span class="c1">// Perform computation using the local memory tile, and</span>
</span><span id="__span-12-110"><a id="__codelineno-12-110" name="__codelineno-12-110"></a><span class="w">              </span><span class="c1">// matrix B in global memory.</span>
</span><span id="__span-12-111"><a id="__codelineno-12-111" name="__codelineno-12-111"></a><span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">B</span><span class="p">;</span><span class="w"> </span><span class="n">kk</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-112"><a id="__codelineno-12-112" name="__codelineno-12-112"></a><span class="w">       </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">tileA</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tileB</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-12-113"><a id="__codelineno-12-113" name="__codelineno-12-113"></a><span class="w">              </span><span class="p">}</span>
</span><span id="__span-12-114"><a id="__codelineno-12-114" name="__codelineno-12-114"></a>
</span><span id="__span-12-115"><a id="__codelineno-12-115" name="__codelineno-12-115"></a><span class="w">              </span><span class="c1">// After computation, synchronize again, to ensure all</span>
</span><span id="__span-12-116"><a id="__codelineno-12-116" name="__codelineno-12-116"></a><span class="w">         </span><span class="c1">// Fill here </span>
</span><span id="__span-12-117"><a id="__codelineno-12-117" name="__codelineno-12-117"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-12-118"><a id="__codelineno-12-118" name="__codelineno-12-118"></a>
</span><span id="__span-12-119"><a id="__codelineno-12-119" name="__codelineno-12-119"></a><span class="w">            </span><span class="c1">// Write the final result to global memory.</span>
</span><span id="__span-12-120"><a id="__codelineno-12-120" name="__codelineno-12-120"></a><span class="w">            </span><span class="n">accessor_c</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-12-121"><a id="__codelineno-12-121" name="__codelineno-12-121"></a>
</span><span id="__span-12-122"><a id="__codelineno-12-122" name="__codelineno-12-122"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-12-123"><a id="__codelineno-12-123" name="__codelineno-12-123"></a><span class="w">      </span><span class="p">});</span>
</span><span id="__span-12-124"><a id="__codelineno-12-124" name="__codelineno-12-124"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-125"><a id="__codelineno-12-125" name="__codelineno-12-125"></a>
</span><span id="__span-12-126"><a id="__codelineno-12-126" name="__codelineno-12-126"></a>
</span><span id="__span-12-127"><a id="__codelineno-12-127" name="__codelineno-12-127"></a><span class="w">  </span><span class="c1">// result is copied back to host automatically when accessors go out of</span>
</span><span id="__span-12-128"><a id="__codelineno-12-128" name="__codelineno-12-128"></a><span class="w">  </span><span class="c1">// scope.</span>
</span><span id="__span-12-129"><a id="__codelineno-12-129" name="__codelineno-12-129"></a>
</span><span id="__span-12-130"><a id="__codelineno-12-130" name="__codelineno-12-130"></a><span class="w">    </span><span class="c1">// verify that Matrix multiplication is correct</span>
</span><span id="__span-12-131"><a id="__codelineno-12-131" name="__codelineno-12-131"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-132"><a id="__codelineno-12-132" name="__codelineno-12-132"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-12-133"><a id="__codelineno-12-133" name="__codelineno-12-133"></a><span class="w">         </span><span class="kt">float</span><span class="w"> </span><span class="n">true_val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
</span><span id="__span-12-134"><a id="__codelineno-12-134" name="__codelineno-12-134"></a><span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-12-135"><a id="__codelineno-12-135" name="__codelineno-12-135"></a><span class="w">           </span><span class="n">true_val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">mat_a</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mat_b</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-12-136"><a id="__codelineno-12-136" name="__codelineno-12-136"></a><span class="w">         </span><span class="p">}</span>
</span><span id="__span-12-137"><a id="__codelineno-12-137" name="__codelineno-12-137"></a><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">true_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mat_c</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">true_val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.0e-4</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-138"><a id="__codelineno-12-138" name="__codelineno-12-138"></a><span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;C[&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;;&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">mat_c</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; expected = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">true_val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-12-139"><a id="__codelineno-12-139" name="__codelineno-12-139"></a><span class="w">            </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-12-140"><a id="__codelineno-12-140" name="__codelineno-12-140"></a><span class="w">         </span><span class="p">}</span>
</span><span id="__span-12-141"><a id="__codelineno-12-141" name="__codelineno-12-141"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-142"><a id="__codelineno-12-142" name="__codelineno-12-142"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-143"><a id="__codelineno-12-143" name="__codelineno-12-143"></a>
</span><span id="__span-12-144"><a id="__codelineno-12-144" name="__codelineno-12-144"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;PASSED&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;FAILED&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-12-145"><a id="__codelineno-12-145" name="__codelineno-12-145"></a>
</span><span id="__span-12-146"><a id="__codelineno-12-146" name="__codelineno-12-146"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-147"><a id="__codelineno-12-147" name="__codelineno-12-147"></a><span class="w">    </span><span class="c1">// Catches exceptions in the host code.</span>
</span><span id="__span-12-148"><a id="__codelineno-12-148" name="__codelineno-12-148"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Caught a SYCL host exception:</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-12-149"><a id="__codelineno-12-149" name="__codelineno-12-149"></a>
</span><span id="__span-12-150"><a id="__codelineno-12-150" name="__codelineno-12-150"></a><span class="w">    </span><span class="c1">// Most likely the runtime couldn&#39;t find FPGA hardware!</span>
</span><span id="__span-12-151"><a id="__codelineno-12-151" name="__codelineno-12-151"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">code</span><span class="p">().</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CL_DEVICE_NOT_FOUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-152"><a id="__codelineno-12-152" name="__codelineno-12-152"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting an FPGA, please ensure that your &quot;</span>
</span><span id="__span-12-153"><a id="__codelineno-12-153" name="__codelineno-12-153"></a><span class="w">                   </span><span class="s">&quot;system has a correctly configured FPGA board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-12-154"><a id="__codelineno-12-154" name="__codelineno-12-154"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Run sys_check in the oneAPI root directory to verify.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-12-155"><a id="__codelineno-12-155" name="__codelineno-12-155"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting the FPGA emulator, compile with &quot;</span>
</span><span id="__span-12-156"><a id="__codelineno-12-156" name="__codelineno-12-156"></a><span class="w">                   </span><span class="s">&quot;-DFPGA_EMULATOR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-12-157"><a id="__codelineno-12-157" name="__codelineno-12-157"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-158"><a id="__codelineno-12-158" name="__codelineno-12-158"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">terminate</span><span class="p">();</span>
</span><span id="__span-12-159"><a id="__codelineno-12-159" name="__codelineno-12-159"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-12-160"><a id="__codelineno-12-160" name="__codelineno-12-160"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
</span><span id="__span-12-161"><a id="__codelineno-12-161" name="__codelineno-12-161"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></li>
</ul>
</div>
<div class="tabbed-block">
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">  1</a></span>
<span class="normal"><a href="#__codelineno-13-2">  2</a></span>
<span class="normal"><a href="#__codelineno-13-3">  3</a></span>
<span class="normal"><a href="#__codelineno-13-4">  4</a></span>
<span class="normal"><a href="#__codelineno-13-5">  5</a></span>
<span class="normal"><a href="#__codelineno-13-6">  6</a></span>
<span class="normal"><a href="#__codelineno-13-7">  7</a></span>
<span class="normal"><a href="#__codelineno-13-8">  8</a></span>
<span class="normal"><a href="#__codelineno-13-9">  9</a></span>
<span class="normal"><a href="#__codelineno-13-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-13-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-13-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-13-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-13-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-13-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-13-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-13-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-13-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-13-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-13-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-13-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-13-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-13-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-13-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-13-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-13-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-13-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-13-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-13-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-13-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-13-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-13-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-13-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-13-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-13-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-13-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-13-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-13-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-13-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-13-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-13-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-13-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-13-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-13-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-13-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-13-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-13-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-13-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-13-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-13-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-13-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-13-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-13-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-13-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-13-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-13-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-13-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-13-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-13-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-13-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-13-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-13-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-13-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-13-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-13-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-13-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-13-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-13-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-13-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-13-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-13-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-13-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-13-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-13-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-13-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-13-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-13-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-13-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-13-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-13-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-13-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-13-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-13-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-13-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-13-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-13-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-13-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-13-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-13-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-13-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-13-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-13-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-13-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-13-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-13-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-13-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-13-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-13-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-13-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-13-100">100</a></span>
<span class="normal"><a href="#__codelineno-13-101">101</a></span>
<span class="normal"><a href="#__codelineno-13-102">102</a></span>
<span class="normal"><a href="#__codelineno-13-103">103</a></span>
<span class="normal"><a href="#__codelineno-13-104">104</a></span>
<span class="normal"><a href="#__codelineno-13-105">105</a></span>
<span class="normal"><a href="#__codelineno-13-106">106</a></span>
<span class="normal"><a href="#__codelineno-13-107">107</a></span>
<span class="normal"><a href="#__codelineno-13-108">108</a></span>
<span class="normal"><a href="#__codelineno-13-109">109</a></span>
<span class="normal"><a href="#__codelineno-13-110">110</a></span>
<span class="normal"><a href="#__codelineno-13-111">111</a></span>
<span class="normal"><a href="#__codelineno-13-112">112</a></span>
<span class="normal"><a href="#__codelineno-13-113">113</a></span>
<span class="normal"><a href="#__codelineno-13-114">114</a></span>
<span class="normal"><a href="#__codelineno-13-115">115</a></span>
<span class="normal"><a href="#__codelineno-13-116">116</a></span>
<span class="normal"><a href="#__codelineno-13-117">117</a></span>
<span class="normal"><a href="#__codelineno-13-118">118</a></span>
<span class="normal"><a href="#__codelineno-13-119">119</a></span>
<span class="normal"><a href="#__codelineno-13-120">120</a></span>
<span class="normal"><a href="#__codelineno-13-121">121</a></span>
<span class="normal"><a href="#__codelineno-13-122">122</a></span>
<span class="normal"><a href="#__codelineno-13-123">123</a></span>
<span class="normal"><a href="#__codelineno-13-124">124</a></span>
<span class="normal"><a href="#__codelineno-13-125">125</a></span>
<span class="normal"><a href="#__codelineno-13-126">126</a></span>
<span class="normal"><a href="#__codelineno-13-127">127</a></span>
<span class="normal"><a href="#__codelineno-13-128">128</a></span>
<span class="normal"><a href="#__codelineno-13-129">129</a></span>
<span class="normal"><a href="#__codelineno-13-130">130</a></span>
<span class="normal"><a href="#__codelineno-13-131">131</a></span>
<span class="normal"><a href="#__codelineno-13-132">132</a></span>
<span class="normal"><a href="#__codelineno-13-133">133</a></span>
<span class="normal"><a href="#__codelineno-13-134">134</a></span>
<span class="normal"><a href="#__codelineno-13-135">135</a></span>
<span class="normal"><a href="#__codelineno-13-136">136</a></span>
<span class="normal"><a href="#__codelineno-13-137">137</a></span>
<span class="normal"><a href="#__codelineno-13-138">138</a></span>
<span class="normal"><a href="#__codelineno-13-139">139</a></span>
<span class="normal"><a href="#__codelineno-13-140">140</a></span>
<span class="normal"><a href="#__codelineno-13-141">141</a></span>
<span class="normal"><a href="#__codelineno-13-142">142</a></span>
<span class="normal"><a href="#__codelineno-13-143">143</a></span>
<span class="normal"><a href="#__codelineno-13-144">144</a></span>
<span class="normal"><a href="#__codelineno-13-145">145</a></span>
<span class="normal"><a href="#__codelineno-13-146">146</a></span>
<span class="normal"><a href="#__codelineno-13-147">147</a></span>
<span class="normal"><a href="#__codelineno-13-148">148</a></span>
<span class="normal"><a href="#__codelineno-13-149">149</a></span>
<span class="normal"><a href="#__codelineno-13-150">150</a></span>
<span class="normal"><a href="#__codelineno-13-151">151</a></span>
<span class="normal"><a href="#__codelineno-13-152">152</a></span>
<span class="normal"><a href="#__codelineno-13-153">153</a></span>
<span class="normal"><a href="#__codelineno-13-154">154</a></span>
<span class="normal"><a href="#__codelineno-13-155">155</a></span>
<span class="normal"><a href="#__codelineno-13-156">156</a></span>
<span class="normal"><a href="#__codelineno-13-157">157</a></span>
<span class="normal"><a href="#__codelineno-13-158">158</a></span>
<span class="normal"><a href="#__codelineno-13-159">159</a></span>
<span class="normal"><a href="#__codelineno-13-160">160</a></span>
<span class="normal"><a href="#__codelineno-13-161">161</a></span>
<span class="normal"><a href="#__codelineno-13-162">162</a></span>
<span class="normal"><a href="#__codelineno-13-163">163</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;algorithm&gt;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;random&gt;</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="c1">// oneAPI headers</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/ext/intel/fpga_extensions.hpp&gt;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;boost/align/aligned_allocator.hpp&gt;</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="c1">// Forward declare the kernel name in the global scope. This is an FPGA best</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="c1">// practice that reduces name mangling in the optimization reports.</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">MatMultKernel</span><span class="p">;</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="w">    </span><span class="c1">// Use compile-time macros to select either:</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="w">    </span><span class="c1">//  - the FPGA emulator device (CPU emulation of the FPGA)</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="w">    </span><span class="c1">//  - the FPGA device (a real FPGA)</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="w">    </span><span class="c1">//  - the simulator device</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="cp">#if FPGA_SIMULATOR</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_simulator_selector_v</span><span class="p">;</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26"></a><span class="cp">#elif FPGA_HARDWARE</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_selector_v</span><span class="p">;</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28"></a><span class="cp">#else  </span><span class="c1">// #if FPGA_EMULATOR</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_emulator_selector_v</span><span class="p">;</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="cp">#endif</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31"></a>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32"></a><span class="w">    </span><span class="c1">// create the device queue</span>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33"></a><span class="w">    </span><span class="n">sycl</span><span class="o">::</span><span class="n">queue</span><span class="w"> </span><span class="n">q</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34"></a>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35"></a><span class="w">    </span><span class="c1">// make sure the device supports USM host allocations</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">get_device</span><span class="p">();</span>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37"></a>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Running on device: &quot;</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="n">get_info</span><span class="o">&lt;</span><span class="n">sycl</span><span class="o">::</span><span class="n">info</span><span class="o">::</span><span class="n">device</span><span class="o">::</span><span class="n">name</span><span class="o">&gt;</span><span class="p">().</span><span class="n">c_str</span><span class="p">()</span>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41"></a>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42"></a>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43"></a><span class="w">    </span><span class="c1">// initialize input and output memory on the host</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44"></a><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span><span class="p">;</span>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45"></a><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="n">boost</span><span class="o">::</span><span class="n">alignment</span><span class="o">::</span><span class="n">aligned_allocator</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">64</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">mat_a</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="n">boost</span><span class="o">::</span><span class="n">alignment</span><span class="o">::</span><span class="n">aligned_allocator</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">64</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">mat_b</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="n">boost</span><span class="o">::</span><span class="n">alignment</span><span class="o">::</span><span class="n">aligned_allocator</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">64</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">mat_c</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">N</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49"></a>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">random_device</span><span class="w"> </span><span class="n">rd</span><span class="p">;</span>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mt19937</span><span class="w"> </span><span class="n">mt</span><span class="p">(</span><span class="n">rd</span><span class="p">());</span>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">uniform_real_distribution</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53"></a>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54"></a><span class="w">    </span><span class="c1">// Generate random values</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">generate</span><span class="p">(</span><span class="n">mat_a</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mat_a</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">dist</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mt</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">mt</span><span class="p">);</span>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58"></a>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59"></a><span class="w">    </span><span class="c1">// Generate random values</span>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">generate</span><span class="p">(</span><span class="n">mat_b</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mat_b</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="n">dist</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mt</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">dist</span><span class="p">(</span><span class="n">mt</span><span class="p">);</span>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63"></a>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64"></a><span class="w">    </span><span class="c1">// fill with zero</span>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">mat_c</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">mat_c</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66"></a>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67"></a>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Matrix multiplication A X B = C &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70"></a><span class="w">      </span><span class="c1">// copy the input arrays to buffers to share with kernel</span>
</span><span id="__span-13-71"><a id="__codelineno-13-71" name="__codelineno-13-71"></a><span class="w">      </span><span class="c1">// We can access the buffer using mat[i][j]</span>
</span><span id="__span-13-72"><a id="__codelineno-13-72" name="__codelineno-13-72"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer_a</span><span class="p">{</span><span class="n">mat_a</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">)};</span>
</span><span id="__span-13-73"><a id="__codelineno-13-73" name="__codelineno-13-73"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer_b</span><span class="p">{</span><span class="n">mat_b</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">)};</span>
</span><span id="__span-13-74"><a id="__codelineno-13-74" name="__codelineno-13-74"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">buffer_c</span><span class="p">{</span><span class="n">mat_c</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">)};</span>
</span><span id="__span-13-75"><a id="__codelineno-13-75" name="__codelineno-13-75"></a>
</span><span id="__span-13-76"><a id="__codelineno-13-76" name="__codelineno-13-76"></a>
</span><span id="__span-13-77"><a id="__codelineno-13-77" name="__codelineno-13-77"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="p">{</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">};</span>
</span><span id="__span-13-78"><a id="__codelineno-13-78" name="__codelineno-13-78"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="w"> </span><span class="n">local</span><span class="w">  </span><span class="p">{</span><span class="n">B</span><span class="p">,</span><span class="n">B</span><span class="p">};</span><span class="w"> </span>
</span><span id="__span-13-79"><a id="__codelineno-13-79" name="__codelineno-13-79"></a>
</span><span id="__span-13-80"><a id="__codelineno-13-80" name="__codelineno-13-80"></a>
</span><span id="__span-13-81"><a id="__codelineno-13-81" name="__codelineno-13-81"></a><span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-82"><a id="__codelineno-13-82" name="__codelineno-13-82"></a><span class="w">        </span><span class="c1">// use accessors to interact with buffers from device code</span>
</span><span id="__span-13-83"><a id="__codelineno-13-83" name="__codelineno-13-83"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">accessor_a</span><span class="p">{</span><span class="n">buffer_a</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-13-84"><a id="__codelineno-13-84" name="__codelineno-13-84"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">accessor_b</span><span class="p">{</span><span class="n">buffer_b</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-13-85"><a id="__codelineno-13-85" name="__codelineno-13-85"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">accessor_c</span><span class="p">{</span><span class="n">buffer_c</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_write</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">no_init</span><span class="p">};</span>
</span><span id="__span-13-86"><a id="__codelineno-13-86" name="__codelineno-13-86"></a>
</span><span id="__span-13-87"><a id="__codelineno-13-87" name="__codelineno-13-87"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">local_accessor</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tileA</span><span class="p">{{</span><span class="n">B</span><span class="p">,</span><span class="n">B</span><span class="p">},</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-13-88"><a id="__codelineno-13-88" name="__codelineno-13-88"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">local_accessor</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tileB</span><span class="p">{{</span><span class="n">B</span><span class="p">,</span><span class="n">B</span><span class="p">},</span><span class="w"> </span><span class="n">h</span><span class="p">};</span>
</span><span id="__span-13-89"><a id="__codelineno-13-89" name="__codelineno-13-89"></a>
</span><span id="__span-13-90"><a id="__codelineno-13-90" name="__codelineno-13-90"></a><span class="w">       </span><span class="n">h</span><span class="p">.</span><span class="n">parallel_for</span><span class="o">&lt;</span><span class="n">MatMultKernel</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">nd_range</span><span class="p">{</span><span class="n">global</span><span class="p">,</span><span class="w"> </span><span class="n">local</span><span class="p">},</span><span class="w"> </span><span class="p">[</span><span class="o">=</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">nd_item</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">)</span>
</span><span id="__span-13-91"><a id="__codelineno-13-91" name="__codelineno-13-91"></a>
</span><span id="__span-13-92"><a id="__codelineno-13-92" name="__codelineno-13-92"></a><span class="w">            </span><span class="p">[[</span><span class="n">intel</span><span class="o">::</span><span class="n">max_work_group_size</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">)]]</span><span class="w">    </span><span class="p">{</span>
</span><span id="__span-13-93"><a id="__codelineno-13-93" name="__codelineno-13-93"></a><span class="w">            </span><span class="c1">// Indices in the global index space:</span>
</span><span id="__span-13-94"><a id="__codelineno-13-94" name="__codelineno-13-94"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">get_global_id</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
</span><span id="__span-13-95"><a id="__codelineno-13-95" name="__codelineno-13-95"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">get_global_id</span><span class="p">()[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-13-96"><a id="__codelineno-13-96" name="__codelineno-13-96"></a>
</span><span id="__span-13-97"><a id="__codelineno-13-97" name="__codelineno-13-97"></a><span class="w">            </span><span class="c1">// Index in the local index space:</span>
</span><span id="__span-13-98"><a id="__codelineno-13-98" name="__codelineno-13-98"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">get_local_id</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
</span><span id="__span-13-99"><a id="__codelineno-13-99" name="__codelineno-13-99"></a><span class="w">           </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="n">get_local_id</span><span class="p">()[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-13-100"><a id="__codelineno-13-100" name="__codelineno-13-100"></a>
</span><span id="__span-13-101"><a id="__codelineno-13-101" name="__codelineno-13-101"></a><span class="w">            </span><span class="kt">float</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-13-102"><a id="__codelineno-13-102" name="__codelineno-13-102"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="o">/</span><span class="n">B</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-103"><a id="__codelineno-13-103" name="__codelineno-13-103"></a><span class="w">              </span><span class="c1">// Load the matrix tile from matrix A, and synchronize</span>
</span><span id="__span-13-104"><a id="__codelineno-13-104" name="__codelineno-13-104"></a><span class="w">              </span><span class="c1">// to ensure all work-items have a consistent view</span>
</span><span id="__span-13-105"><a id="__codelineno-13-105" name="__codelineno-13-105"></a><span class="w">              </span><span class="c1">// of the matrix tile in local memory.</span>
</span><span id="__span-13-106"><a id="__codelineno-13-106" name="__codelineno-13-106"></a><span class="w">              </span><span class="n">tileA</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accessor_a</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">p</span><span class="o">*</span><span class="n">B</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-13-107"><a id="__codelineno-13-107" name="__codelineno-13-107"></a><span class="w">              </span><span class="n">tileB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accessor_b</span><span class="p">[</span><span class="n">p</span><span class="o">*</span><span class="n">B</span><span class="o">+</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="p">];</span>
</span><span id="__span-13-108"><a id="__codelineno-13-108" name="__codelineno-13-108"></a><span class="w">              </span><span class="n">item</span><span class="p">.</span><span class="n">barrier</span><span class="p">();</span>
</span><span id="__span-13-109"><a id="__codelineno-13-109" name="__codelineno-13-109"></a>
</span><span id="__span-13-110"><a id="__codelineno-13-110" name="__codelineno-13-110"></a><span class="w">              </span><span class="c1">// Perform computation using the local memory tile, and</span>
</span><span id="__span-13-111"><a id="__codelineno-13-111" name="__codelineno-13-111"></a><span class="w">              </span><span class="c1">// matrix B in global memory.</span>
</span><span id="__span-13-112"><a id="__codelineno-13-112" name="__codelineno-13-112"></a><span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">kk</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">B</span><span class="p">;</span><span class="w"> </span><span class="n">kk</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-113"><a id="__codelineno-13-113" name="__codelineno-13-113"></a><span class="w">               </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">tileA</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">kk</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">tileB</span><span class="p">[</span><span class="n">kk</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-13-114"><a id="__codelineno-13-114" name="__codelineno-13-114"></a><span class="w">              </span><span class="p">}</span>
</span><span id="__span-13-115"><a id="__codelineno-13-115" name="__codelineno-13-115"></a>
</span><span id="__span-13-116"><a id="__codelineno-13-116" name="__codelineno-13-116"></a><span class="w">              </span><span class="c1">// After computation, synchronize again, to ensure all</span>
</span><span id="__span-13-117"><a id="__codelineno-13-117" name="__codelineno-13-117"></a><span class="w">              </span><span class="c1">// reads from the local memory tile are complete.</span>
</span><span id="__span-13-118"><a id="__codelineno-13-118" name="__codelineno-13-118"></a><span class="w">              </span><span class="n">item</span><span class="p">.</span><span class="n">barrier</span><span class="p">();</span>
</span><span id="__span-13-119"><a id="__codelineno-13-119" name="__codelineno-13-119"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-13-120"><a id="__codelineno-13-120" name="__codelineno-13-120"></a>
</span><span id="__span-13-121"><a id="__codelineno-13-121" name="__codelineno-13-121"></a><span class="w">            </span><span class="c1">// Write the final result to global memory.</span>
</span><span id="__span-13-122"><a id="__codelineno-13-122" name="__codelineno-13-122"></a><span class="w">            </span><span class="n">accessor_c</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">n</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">;</span>
</span><span id="__span-13-123"><a id="__codelineno-13-123" name="__codelineno-13-123"></a>
</span><span id="__span-13-124"><a id="__codelineno-13-124" name="__codelineno-13-124"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-13-125"><a id="__codelineno-13-125" name="__codelineno-13-125"></a><span class="w">      </span><span class="p">});</span>
</span><span id="__span-13-126"><a id="__codelineno-13-126" name="__codelineno-13-126"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-127"><a id="__codelineno-13-127" name="__codelineno-13-127"></a>
</span><span id="__span-13-128"><a id="__codelineno-13-128" name="__codelineno-13-128"></a>
</span><span id="__span-13-129"><a id="__codelineno-13-129" name="__codelineno-13-129"></a><span class="w">  </span><span class="c1">// result is copied back to host automatically when accessors go out of</span>
</span><span id="__span-13-130"><a id="__codelineno-13-130" name="__codelineno-13-130"></a><span class="w">    </span><span class="c1">// scope.</span>
</span><span id="__span-13-131"><a id="__codelineno-13-131" name="__codelineno-13-131"></a>
</span><span id="__span-13-132"><a id="__codelineno-13-132" name="__codelineno-13-132"></a><span class="w">    </span><span class="c1">// verify that Matrix multiplication is correct</span>
</span><span id="__span-13-133"><a id="__codelineno-13-133" name="__codelineno-13-133"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-134"><a id="__codelineno-13-134" name="__codelineno-13-134"></a><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-13-135"><a id="__codelineno-13-135" name="__codelineno-13-135"></a><span class="w">      </span><span class="kt">float</span><span class="w"> </span><span class="n">true_val</span><span class="o">=</span><span class="mf">0.0</span><span class="p">;</span>
</span><span id="__span-13-136"><a id="__codelineno-13-136" name="__codelineno-13-136"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-13-137"><a id="__codelineno-13-137" name="__codelineno-13-137"></a><span class="w">       </span><span class="n">true_val</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">mat_a</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N</span><span class="w"> </span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">mat_b</span><span class="p">[</span><span class="n">k</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">j</span><span class="p">];</span>
</span><span id="__span-13-138"><a id="__codelineno-13-138" name="__codelineno-13-138"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-13-139"><a id="__codelineno-13-139" name="__codelineno-13-139"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">true_val</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">mat_c</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="n">true_val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.0e-4</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-140"><a id="__codelineno-13-140" name="__codelineno-13-140"></a><span class="w">               </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;C[&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;;&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;] = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">mat_c</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; expected = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">true_val</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-13-141"><a id="__codelineno-13-141" name="__codelineno-13-141"></a><span class="w">               </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-13-142"><a id="__codelineno-13-142" name="__codelineno-13-142"></a><span class="w">           </span><span class="p">}</span>
</span><span id="__span-13-143"><a id="__codelineno-13-143" name="__codelineno-13-143"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-13-144"><a id="__codelineno-13-144" name="__codelineno-13-144"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-145"><a id="__codelineno-13-145" name="__codelineno-13-145"></a>
</span><span id="__span-13-146"><a id="__codelineno-13-146" name="__codelineno-13-146"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;PASSED&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;FAILED&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-13-147"><a id="__codelineno-13-147" name="__codelineno-13-147"></a>
</span><span id="__span-13-148"><a id="__codelineno-13-148" name="__codelineno-13-148"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-149"><a id="__codelineno-13-149" name="__codelineno-13-149"></a><span class="w">    </span><span class="c1">// Catches exceptions in the host code.</span>
</span><span id="__span-13-150"><a id="__codelineno-13-150" name="__codelineno-13-150"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Caught a SYCL host exception:</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-13-151"><a id="__codelineno-13-151" name="__codelineno-13-151"></a>
</span><span id="__span-13-152"><a id="__codelineno-13-152" name="__codelineno-13-152"></a><span class="w">    </span><span class="c1">// Most likely the runtime couldn&#39;t find FPGA hardware!</span>
</span><span id="__span-13-153"><a id="__codelineno-13-153" name="__codelineno-13-153"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">code</span><span class="p">().</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CL_DEVICE_NOT_FOUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-154"><a id="__codelineno-13-154" name="__codelineno-13-154"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting an FPGA, please ensure that your &quot;</span>
</span><span id="__span-13-155"><a id="__codelineno-13-155" name="__codelineno-13-155"></a><span class="w">                   </span><span class="s">&quot;system has a correctly configured FPGA board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-13-156"><a id="__codelineno-13-156" name="__codelineno-13-156"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Run sys_check in the oneAPI root directory to verify.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-13-157"><a id="__codelineno-13-157" name="__codelineno-13-157"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting the FPGA emulator, compile with &quot;</span>
</span><span id="__span-13-158"><a id="__codelineno-13-158" name="__codelineno-13-158"></a><span class="w">                   </span><span class="s">&quot;-DFPGA_EMULATOR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-13-159"><a id="__codelineno-13-159" name="__codelineno-13-159"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-160"><a id="__codelineno-13-160" name="__codelineno-13-160"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">terminate</span><span class="p">();</span>
</span><span id="__span-13-161"><a id="__codelineno-13-161" name="__codelineno-13-161"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-13-162"><a id="__codelineno-13-162" name="__codelineno-13-162"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
</span><span id="__span-13-163"><a id="__codelineno-13-163" name="__codelineno-13-163"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning on work-items group size</p>
<ul>
<li>If the attribute [[intel::max_work_group_size(Z, Y, X)]] is not specified in your kernel, the workgroup size assumes a default value depending on compilation time and runtime constraints</li>
<li>If your kernel contains a barrier, the Intel® oneAPI DPC++/C++ Compiler sets a default maximum scalarized work-group size of 128 work-items ==&gt; without this attribute, the previous ND-Range kernel would have failed since we have a local work-group size of B x B = 256 work-items </li>
</ul>
</div>
<h3 id="pipelining-with-single-work-item-loop">Pipelining with single-work item (loop)<a class="headerlink" href="#pipelining-with-single-work-item-loop" title="Permanent link">&para;</a></h3>
<ul>
<li>When your code can't be decomposed into independent works, you can rely on loop parallelism using FPGA</li>
<li>In such a situation, the pipeline inputs is not work-items but loop iterations</li>
<li>For single-work-item kernels, the programmer need not do anything special to preserve the data dependency </li>
<li>Communications between kernels is also much easier</li>
</ul>
<figure>
<p><img alt="" src="../images/loop_pipeline.png" />
  </p>
<figcaption><a href=https://link.springer.com/book/10.1007/978-1-4842-5574-2>DPC++ book</a> -- Figure 17-21 </figcaption>
</figure>
<ul>
<li>FPGA can efficiently handle loop execution, often maintaining a fully occupied pipeline or providing reports on what changes are necessary to enhance occupancy.</li>
<li>It's evident that if loop iterations were substituted with work-items, where the value created by one work-item would have to be transferred to another for incremental computation, the algorithm's description would become far more complex.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Single-work item creation</p>
<ul>
<li>Replace the <code>parallel_for</code>method by the <code>single_task</code> method defined in the handler class to create a single-work item kernel</li>
<li>The source file <code>vector_add.cpp</code> from <code>GettingStarted/fpga_compile/part4_dpcpp_lambda_buffers/src</code> uses loop pipelining.</li>
</ul>
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="w">  </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/ext/intel/fpga_extensions.hpp&gt;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">  </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">  </span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">sycl</span><span class="p">;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(){</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">  </span><span class="c1">// queue creation &amp; data initialization</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">   </span><span class="n">q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="w">     </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">MyKernel</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">       </span><span class="c1">// Code to be executed as a single task</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="w">     </span><span class="p">});</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="w">   </span><span class="p">});</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">   </span><span class="n">q</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">  </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Inferring a shift register -- the accumulator case</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:3"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><input id="__tabbed_8_3" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">Problem</label><label for="__tabbed_8_2">Question</label><label for="__tabbed_8_3">Solution</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<ul>
<li>The following code sums double precision floating-point array</li>
<li>The problem is the following one:</li>
<li>For each loop iteration, the Intel® oneAPI DPC++/C++ Compiler takes &gt;1 cycles to compute the result of the addition and then stores it in the variable temp_sum</li>
<li>So you have a data dependency on temp_sum
 <div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span>
<span class="normal"><a href="#__codelineno-15-24">24</a></span>
<span class="normal"><a href="#__codelineno-15-25">25</a></span>
<span class="normal"><a href="#__codelineno-15-26">26</a></span>
<span class="normal"><a href="#__codelineno-15-27">27</a></span>
<span class="normal"><a href="#__codelineno-15-28">28</a></span>
<span class="normal"><a href="#__codelineno-15-29">29</a></span>
<span class="normal"><a href="#__codelineno-15-30">30</a></span>
<span class="normal"><a href="#__codelineno-15-31">31</a></span>
<span class="normal"><a href="#__codelineno-15-32">32</a></span>
<span class="normal"><a href="#__codelineno-15-33">33</a></span>
<span class="normal"><a href="#__codelineno-15-34">34</a></span>
<span class="normal"><a href="#__codelineno-15-35">35</a></span>
<span class="normal"><a href="#__codelineno-15-36">36</a></span>
<span class="normal"><a href="#__codelineno-15-37">37</a></span>
<span class="normal"><a href="#__codelineno-15-38">38</a></span>
<span class="normal"><a href="#__codelineno-15-39">39</a></span>
<span class="normal"><a href="#__codelineno-15-40">40</a></span>
<span class="normal"><a href="#__codelineno-15-41">41</a></span>
<span class="normal"><a href="#__codelineno-15-42">42</a></span>
<span class="normal"><a href="#__codelineno-15-43">43</a></span>
<span class="normal"><a href="#__codelineno-15-44">44</a></span>
<span class="normal"><a href="#__codelineno-15-45">45</a></span>
<span class="normal"><a href="#__codelineno-15-46">46</a></span>
<span class="normal"><a href="#__codelineno-15-47">47</a></span>
<span class="normal"><a href="#__codelineno-15-48">48</a></span>
<span class="normal"><a href="#__codelineno-15-49">49</a></span>
<span class="normal"><a href="#__codelineno-15-50">50</a></span>
<span class="normal"><a href="#__codelineno-15-51">51</a></span>
<span class="normal"><a href="#__codelineno-15-52">52</a></span>
<span class="normal"><a href="#__codelineno-15-53">53</a></span>
<span class="normal"><a href="#__codelineno-15-54">54</a></span>
<span class="normal"><a href="#__codelineno-15-55">55</a></span>
<span class="normal"><a href="#__codelineno-15-56">56</a></span>
<span class="normal"><a href="#__codelineno-15-57">57</a></span>
<span class="normal"><a href="#__codelineno-15-58">58</a></span>
<span class="normal"><a href="#__codelineno-15-59">59</a></span>
<span class="normal"><a href="#__codelineno-15-60">60</a></span>
<span class="normal"><a href="#__codelineno-15-61">61</a></span>
<span class="normal"><a href="#__codelineno-15-62">62</a></span>
<span class="normal"><a href="#__codelineno-15-63">63</a></span>
<span class="normal"><a href="#__codelineno-15-64">64</a></span>
<span class="normal"><a href="#__codelineno-15-65">65</a></span>
<span class="normal"><a href="#__codelineno-15-66">66</a></span>
<span class="normal"><a href="#__codelineno-15-67">67</a></span>
<span class="normal"><a href="#__codelineno-15-68">68</a></span>
<span class="normal"><a href="#__codelineno-15-69">69</a></span>
<span class="normal"><a href="#__codelineno-15-70">70</a></span>
<span class="normal"><a href="#__codelineno-15-71">71</a></span>
<span class="normal"><a href="#__codelineno-15-72">72</a></span>
<span class="normal"><a href="#__codelineno-15-73">73</a></span>
<span class="normal"><a href="#__codelineno-15-74">74</a></span>
<span class="normal"><a href="#__codelineno-15-75">75</a></span>
<span class="normal"><a href="#__codelineno-15-76">76</a></span>
<span class="normal"><a href="#__codelineno-15-77">77</a></span>
<span class="normal"><a href="#__codelineno-15-78">78</a></span>
<span class="normal"><a href="#__codelineno-15-79">79</a></span>
<span class="normal"><a href="#__codelineno-15-80">80</a></span>
<span class="normal"><a href="#__codelineno-15-81">81</a></span>
<span class="normal"><a href="#__codelineno-15-82">82</a></span>
<span class="normal"><a href="#__codelineno-15-83">83</a></span>
<span class="normal"><a href="#__codelineno-15-84">84</a></span>
<span class="normal"><a href="#__codelineno-15-85">85</a></span>
<span class="normal"><a href="#__codelineno-15-86">86</a></span>
<span class="normal"><a href="#__codelineno-15-87">87</a></span>
<span class="normal"><a href="#__codelineno-15-88">88</a></span>
<span class="normal"><a href="#__codelineno-15-89">89</a></span>
<span class="normal"><a href="#__codelineno-15-90">90</a></span>
<span class="normal"><a href="#__codelineno-15-91">91</a></span>
<span class="normal"><a href="#__codelineno-15-92">92</a></span>
<span class="normal"><a href="#__codelineno-15-93">93</a></span>
<span class="normal"><a href="#__codelineno-15-94">94</a></span>
<span class="normal"><a href="#__codelineno-15-95">95</a></span>
<span class="normal"><a href="#__codelineno-15-96">96</a></span>
<span class="normal"><a href="#__codelineno-15-97">97</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="c1">// oneAPI headers</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/ext/intel/fpga_extensions.hpp&gt;</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="c1">// Forward declare the kernel name in the global scope. This is an FPGA best</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="c1">// practice that reduces name mangling in the optimization reports.</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Accumulator</span><span class="p">;</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">    </span><span class="c1">// Use compile-time macros to select either:</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span><span class="c1">//  - the FPGA emulator device (CPU emulation of the FPGA)</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">    </span><span class="c1">//  - the FPGA device (a real FPGA)</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">    </span><span class="c1">//  - the simulator device</span>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="cp">#if FPGA_SIMULATOR</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_simulator_selector_v</span><span class="p">;</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="cp">#elif FPGA_HARDWARE</span>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_selector_v</span><span class="p">;</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="cp">#else  </span><span class="c1">// #if FPGA_EMULATOR</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_emulator_selector_v</span><span class="p">;</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="cp">#endif</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27"></a>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="w">    </span><span class="c1">// create the device queue</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="w">    </span><span class="n">sycl</span><span class="o">::</span><span class="n">queue</span><span class="w"> </span><span class="n">q</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30"></a>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="w">    </span><span class="c1">// make sure the device supports USM host allocations</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">get_device</span><span class="p">();</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33"></a>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Running on device: &quot;</span>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="n">get_info</span><span class="o">&lt;</span><span class="n">sycl</span><span class="o">::</span><span class="n">info</span><span class="o">::</span><span class="n">device</span><span class="o">::</span><span class="n">name</span><span class="o">&gt;</span><span class="p">().</span><span class="n">c_str</span><span class="p">()</span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37"></a>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38"></a><span class="w">    </span><span class="c1">// declare arrays and fill them</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">align_val_t</span><span class="p">{</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42"></a><span class="w">      </span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44"></a>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Accumulate values &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47"></a><span class="w">      </span><span class="c1">// copy the input arrays to buffers to share with kernel</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="w"> </span><span class="n">buffer_in</span><span class="p">{</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="p">(</span><span class="n">kVectSize</span><span class="p">)};</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="w"> </span><span class="n">buffer_out</span><span class="p">{</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">)};</span>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50"></a>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51"></a><span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52"></a><span class="w">        </span><span class="c1">// use accessors to interact with buffers from device code</span>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">arr</span><span class="p">{</span><span class="n">buffer_in</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">result</span><span class="p">{</span><span class="n">buffer_out</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">write_only</span><span class="p">,</span><span class="n">sycl</span><span class="o">::</span><span class="n">no_init</span><span class="p">};</span>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55"></a>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">Accumulator</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57"></a><span class="w">     </span><span class="kt">double</span><span class="w"> </span><span class="n">temp_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58"></a><span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59"></a><span class="w">            </span><span class="n">temp_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60"></a><span class="w">          </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_sum</span><span class="p">;</span>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61"></a><span class="w">        </span><span class="p">});</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62"></a><span class="w">      </span><span class="p">});</span>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64"></a><span class="w">    </span><span class="c1">// result is copied back to host automatically when accessors go out of</span>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65"></a><span class="w">    </span><span class="c1">// scope.</span>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66"></a>
</span><span id="__span-15-67"><a id="__codelineno-15-67" name="__codelineno-15-67"></a><span class="w">    </span><span class="c1">// verify that Accumulation is correct</span>
</span><span id="__span-15-68"><a id="__codelineno-15-68" name="__codelineno-15-68"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-15-69"><a id="__codelineno-15-69" name="__codelineno-15-69"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-15-70"><a id="__codelineno-15-70" name="__codelineno-15-70"></a><span class="w">      </span><span class="n">expected</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-15-71"><a id="__codelineno-15-71" name="__codelineno-15-71"></a>
</span><span id="__span-15-72"><a id="__codelineno-15-72" name="__codelineno-15-72"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-73"><a id="__codelineno-15-73" name="__codelineno-15-73"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;res = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="s">&quot;, expected = &quot;</span>
</span><span id="__span-15-74"><a id="__codelineno-15-74" name="__codelineno-15-74"></a><span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-15-75"><a id="__codelineno-15-75" name="__codelineno-15-75"></a><span class="w">        </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-15-76"><a id="__codelineno-15-76" name="__codelineno-15-76"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-15-77"><a id="__codelineno-15-77" name="__codelineno-15-77"></a>
</span><span id="__span-15-78"><a id="__codelineno-15-78" name="__codelineno-15-78"></a>
</span><span id="__span-15-79"><a id="__codelineno-15-79" name="__codelineno-15-79"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;PASSED&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;FAILED&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-15-80"><a id="__codelineno-15-80" name="__codelineno-15-80"></a>
</span><span id="__span-15-81"><a id="__codelineno-15-81" name="__codelineno-15-81"></a><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">vec</span><span class="p">;</span>
</span><span id="__span-15-82"><a id="__codelineno-15-82" name="__codelineno-15-82"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-83"><a id="__codelineno-15-83" name="__codelineno-15-83"></a><span class="w">    </span><span class="c1">// Catches exceptions in the host code.</span>
</span><span id="__span-15-84"><a id="__codelineno-15-84" name="__codelineno-15-84"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Caught a SYCL host exception:</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-15-85"><a id="__codelineno-15-85" name="__codelineno-15-85"></a>
</span><span id="__span-15-86"><a id="__codelineno-15-86" name="__codelineno-15-86"></a><span class="w">    </span><span class="c1">// Most likely the runtime couldn&#39;t find FPGA hardware!</span>
</span><span id="__span-15-87"><a id="__codelineno-15-87" name="__codelineno-15-87"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">code</span><span class="p">().</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CL_DEVICE_NOT_FOUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-88"><a id="__codelineno-15-88" name="__codelineno-15-88"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting an FPGA, please ensure that your &quot;</span>
</span><span id="__span-15-89"><a id="__codelineno-15-89" name="__codelineno-15-89"></a><span class="w">                   </span><span class="s">&quot;system has a correctly configured FPGA board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-15-90"><a id="__codelineno-15-90" name="__codelineno-15-90"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Run sys_check in the oneAPI root directory to verify.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-15-91"><a id="__codelineno-15-91" name="__codelineno-15-91"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting the FPGA emulator, compile with &quot;</span>
</span><span id="__span-15-92"><a id="__codelineno-15-92" name="__codelineno-15-92"></a><span class="w">                   </span><span class="s">&quot;-DFPGA_EMULATOR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-15-93"><a id="__codelineno-15-93" name="__codelineno-15-93"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-94"><a id="__codelineno-15-94" name="__codelineno-15-94"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">terminate</span><span class="p">();</span>
</span><span id="__span-15-95"><a id="__codelineno-15-95" name="__codelineno-15-95"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-15-96"><a id="__codelineno-15-96" name="__codelineno-15-96"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
</span><span id="__span-15-97"><a id="__codelineno-15-97" name="__codelineno-15-97"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></li>
</ul>
</div>
<div class="tabbed-block">
<ul>
<li>The following code rely on a shift register to relax the data dependency</li>
<li>Fill in the blank to complete the implementation
 <div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">  1</a></span>
<span class="normal"><a href="#__codelineno-16-2">  2</a></span>
<span class="normal"><a href="#__codelineno-16-3">  3</a></span>
<span class="normal"><a href="#__codelineno-16-4">  4</a></span>
<span class="normal"><a href="#__codelineno-16-5">  5</a></span>
<span class="normal"><a href="#__codelineno-16-6">  6</a></span>
<span class="normal"><a href="#__codelineno-16-7">  7</a></span>
<span class="normal"><a href="#__codelineno-16-8">  8</a></span>
<span class="normal"><a href="#__codelineno-16-9">  9</a></span>
<span class="normal"><a href="#__codelineno-16-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-16-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-16-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-16-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-16-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-16-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-16-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-16-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-16-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-16-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-16-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-16-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-16-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-16-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-16-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-16-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-16-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-16-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-16-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-16-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-16-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-16-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-16-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-16-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-16-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-16-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-16-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-16-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-16-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-16-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-16-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-16-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-16-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-16-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-16-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-16-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-16-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-16-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-16-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-16-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-16-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-16-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-16-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-16-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-16-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-16-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-16-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-16-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-16-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-16-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-16-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-16-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-16-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-16-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-16-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-16-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-16-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-16-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-16-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-16-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-16-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-16-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-16-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-16-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-16-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-16-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-16-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-16-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-16-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-16-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-16-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-16-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-16-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-16-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-16-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-16-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-16-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-16-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-16-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-16-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-16-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-16-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-16-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-16-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-16-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-16-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-16-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-16-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-16-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-16-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-16-100">100</a></span>
<span class="normal"><a href="#__codelineno-16-101">101</a></span>
<span class="normal"><a href="#__codelineno-16-102">102</a></span>
<span class="normal"><a href="#__codelineno-16-103">103</a></span>
<span class="normal"><a href="#__codelineno-16-104">104</a></span>
<span class="normal"><a href="#__codelineno-16-105">105</a></span>
<span class="normal"><a href="#__codelineno-16-106">106</a></span>
<span class="normal"><a href="#__codelineno-16-107">107</a></span>
<span class="normal"><a href="#__codelineno-16-108">108</a></span>
<span class="normal"><a href="#__codelineno-16-109">109</a></span>
<span class="normal"><a href="#__codelineno-16-110">110</a></span>
<span class="normal"><a href="#__codelineno-16-111">111</a></span>
<span class="normal"><a href="#__codelineno-16-112">112</a></span>
<span class="normal"><a href="#__codelineno-16-113">113</a></span>
<span class="normal"><a href="#__codelineno-16-114">114</a></span>
<span class="normal"><a href="#__codelineno-16-115">115</a></span>
<span class="normal"><a href="#__codelineno-16-116">116</a></span>
<span class="normal"><a href="#__codelineno-16-117">117</a></span>
<span class="normal"><a href="#__codelineno-16-118">118</a></span>
<span class="normal"><a href="#__codelineno-16-119">119</a></span>
<span class="normal"><a href="#__codelineno-16-120">120</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="c1">// oneAPI headers</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/ext/intel/fpga_extensions.hpp&gt;</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="c1">// Forward declare the kernel name in the global scope. This is an FPGA best</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="c1">// practice that reduces name mangling in the optimization reports.</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Accumulator</span><span class="p">;</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="c1">// Initialization cycle (let us take a bit more than 10)</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">II_CYCLES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14"></a>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="w">    </span><span class="c1">// Use compile-time macros to select either:</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="w">    </span><span class="c1">//  - the FPGA emulator device (CPU emulation of the FPGA)</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="w">    </span><span class="c1">//  - the FPGA device (a real FPGA)</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="w">    </span><span class="c1">//  - the simulator device</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="cp">#if FPGA_SIMULATOR</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_simulator_selector_v</span><span class="p">;</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="cp">#elif FPGA_HARDWARE</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_selector_v</span><span class="p">;</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26"></a><span class="cp">#else  </span><span class="c1">// #if FPGA_EMULATOR</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_emulator_selector_v</span><span class="p">;</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28"></a><span class="cp">#endif</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29"></a>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30"></a><span class="w">    </span><span class="c1">// create the device queue</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31"></a><span class="w">    </span><span class="n">sycl</span><span class="o">::</span><span class="n">queue</span><span class="w"> </span><span class="n">q</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32"></a>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33"></a><span class="w">    </span><span class="c1">// make sure the device supports USM host allocations</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">get_device</span><span class="p">();</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35"></a>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Running on device: &quot;</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="n">get_info</span><span class="o">&lt;</span><span class="n">sycl</span><span class="o">::</span><span class="n">info</span><span class="o">::</span><span class="n">device</span><span class="o">::</span><span class="n">name</span><span class="o">&gt;</span><span class="p">().</span><span class="n">c_str</span><span class="p">()</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39"></a>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40"></a><span class="w">    </span><span class="c1">// declare arrays and fill them</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">align_val_t</span><span class="p">{</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44"></a><span class="w">      </span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
</span><span id="__span-16-45"><a id="__codelineno-16-45" name="__codelineno-16-45"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-46"><a id="__codelineno-16-46" name="__codelineno-16-46"></a>
</span><span id="__span-16-47"><a id="__codelineno-16-47" name="__codelineno-16-47"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Accumulate values &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-16-48"><a id="__codelineno-16-48" name="__codelineno-16-48"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-16-49"><a id="__codelineno-16-49" name="__codelineno-16-49"></a><span class="w">      </span><span class="c1">// copy the input arrays to buffers to share with kernel</span>
</span><span id="__span-16-50"><a id="__codelineno-16-50" name="__codelineno-16-50"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="w"> </span><span class="n">buffer_in</span><span class="p">{</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="p">(</span><span class="n">kVectSize</span><span class="p">)};</span>
</span><span id="__span-16-51"><a id="__codelineno-16-51" name="__codelineno-16-51"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="w"> </span><span class="n">buffer_out</span><span class="p">{</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">)};</span>
</span><span id="__span-16-52"><a id="__codelineno-16-52" name="__codelineno-16-52"></a>
</span><span id="__span-16-53"><a id="__codelineno-16-53" name="__codelineno-16-53"></a><span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-54"><a id="__codelineno-16-54" name="__codelineno-16-54"></a><span class="w">        </span><span class="c1">// use accessors to interact with buffers from device code</span>
</span><span id="__span-16-55"><a id="__codelineno-16-55" name="__codelineno-16-55"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">arr</span><span class="p">{</span><span class="n">buffer_in</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-16-56"><a id="__codelineno-16-56" name="__codelineno-16-56"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">result</span><span class="p">{</span><span class="n">buffer_out</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">write_only</span><span class="p">,</span><span class="n">sycl</span><span class="o">::</span><span class="n">no_init</span><span class="p">};</span>
</span><span id="__span-16-57"><a id="__codelineno-16-57" name="__codelineno-16-57"></a>
</span><span id="__span-16-58"><a id="__codelineno-16-58" name="__codelineno-16-58"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">Accumulator</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-59"><a id="__codelineno-16-59" name="__codelineno-16-59"></a><span class="w">       </span><span class="c1">//Create shift register with II_CYCLE+1 elements</span>
</span><span id="__span-16-60"><a id="__codelineno-16-60" name="__codelineno-16-60"></a><span class="w">       </span><span class="kt">double</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">II_CYCLES</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-16-61"><a id="__codelineno-16-61" name="__codelineno-16-61"></a><span class="w">       </span><span class="c1">//Initialize all elements of the register to 0</span>
</span><span id="__span-16-62"><a id="__codelineno-16-62" name="__codelineno-16-62"></a><span class="w">       </span><span class="c1">//You must initialize the shift register </span>
</span><span id="__span-16-63"><a id="__codelineno-16-63" name="__codelineno-16-63"></a><span class="w">        </span><span class="c1">// fill here</span>
</span><span id="__span-16-64"><a id="__codelineno-16-64" name="__codelineno-16-64"></a>
</span><span id="__span-16-65"><a id="__codelineno-16-65" name="__codelineno-16-65"></a><span class="w">       </span><span class="c1">//Iterate through every element of input array</span>
</span><span id="__span-16-66"><a id="__codelineno-16-66" name="__codelineno-16-66"></a><span class="w">       </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span><span id="__span-16-67"><a id="__codelineno-16-67" name="__codelineno-16-67"></a><span class="w">          </span><span class="c1">//Load ith element into end of shift register</span>
</span><span id="__span-16-68"><a id="__codelineno-16-68" name="__codelineno-16-68"></a><span class="w">          </span><span class="c1">//if N &gt; II_CYCLE, add to shift_reg[0] to preserve values</span>
</span><span id="__span-16-69"><a id="__codelineno-16-69" name="__codelineno-16-69"></a><span class="w">          </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">II_CYCLES</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-16-70"><a id="__codelineno-16-70" name="__codelineno-16-70"></a>
</span><span id="__span-16-71"><a id="__codelineno-16-71" name="__codelineno-16-71"></a><span class="w">          </span><span class="cp">#pragma unroll</span>
</span><span id="__span-16-72"><a id="__codelineno-16-72" name="__codelineno-16-72"></a><span class="w">          </span><span class="c1">//Shift every element of shift register</span>
</span><span id="__span-16-73"><a id="__codelineno-16-73" name="__codelineno-16-73"></a><span class="w">          </span><span class="c1">//Done in 1 cycle if using loop unrolling</span>
</span><span id="__span-16-74"><a id="__codelineno-16-74" name="__codelineno-16-74"></a><span class="w">           </span><span class="c1">// fill here</span>
</span><span id="__span-16-75"><a id="__codelineno-16-75" name="__codelineno-16-75"></a>
</span><span id="__span-16-76"><a id="__codelineno-16-76" name="__codelineno-16-76"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-77"><a id="__codelineno-16-77" name="__codelineno-16-77"></a><span class="w">       </span><span class="c1">//Sum every element of shift register</span>
</span><span id="__span-16-78"><a id="__codelineno-16-78" name="__codelineno-16-78"></a><span class="w">       </span><span class="kt">double</span><span class="w"> </span><span class="n">temp_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-16-79"><a id="__codelineno-16-79" name="__codelineno-16-79"></a><span class="w">       </span><span class="cp">#pragma unroll</span>
</span><span id="__span-16-80"><a id="__codelineno-16-80" name="__codelineno-16-80"></a><span class="w">       </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">II_CYCLES</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span><span id="__span-16-81"><a id="__codelineno-16-81" name="__codelineno-16-81"></a><span class="w">             </span><span class="n">temp_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-16-82"><a id="__codelineno-16-82" name="__codelineno-16-82"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-16-83"><a id="__codelineno-16-83" name="__codelineno-16-83"></a><span class="w">        </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_sum</span><span class="p">;</span>
</span><span id="__span-16-84"><a id="__codelineno-16-84" name="__codelineno-16-84"></a><span class="w">           </span><span class="p">});</span>
</span><span id="__span-16-85"><a id="__codelineno-16-85" name="__codelineno-16-85"></a><span class="w">         </span><span class="p">});</span>
</span><span id="__span-16-86"><a id="__codelineno-16-86" name="__codelineno-16-86"></a><span class="w">       </span><span class="p">}</span>
</span><span id="__span-16-87"><a id="__codelineno-16-87" name="__codelineno-16-87"></a><span class="w">    </span><span class="c1">// result is copied back to host automatically when accessors go out of</span>
</span><span id="__span-16-88"><a id="__codelineno-16-88" name="__codelineno-16-88"></a><span class="w">    </span><span class="c1">// scope.</span>
</span><span id="__span-16-89"><a id="__codelineno-16-89" name="__codelineno-16-89"></a>
</span><span id="__span-16-90"><a id="__codelineno-16-90" name="__codelineno-16-90"></a><span class="w">    </span><span class="c1">// verify that Accumulation is correct</span>
</span><span id="__span-16-91"><a id="__codelineno-16-91" name="__codelineno-16-91"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-16-92"><a id="__codelineno-16-92" name="__codelineno-16-92"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-16-93"><a id="__codelineno-16-93" name="__codelineno-16-93"></a><span class="w">      </span><span class="n">expected</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-16-94"><a id="__codelineno-16-94" name="__codelineno-16-94"></a>
</span><span id="__span-16-95"><a id="__codelineno-16-95" name="__codelineno-16-95"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-96"><a id="__codelineno-16-96" name="__codelineno-16-96"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;res = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="s">&quot;, expected = &quot;</span>
</span><span id="__span-16-97"><a id="__codelineno-16-97" name="__codelineno-16-97"></a><span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-16-98"><a id="__codelineno-16-98" name="__codelineno-16-98"></a><span class="w">        </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-16-99"><a id="__codelineno-16-99" name="__codelineno-16-99"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-16-100"><a id="__codelineno-16-100" name="__codelineno-16-100"></a>
</span><span id="__span-16-101"><a id="__codelineno-16-101" name="__codelineno-16-101"></a>
</span><span id="__span-16-102"><a id="__codelineno-16-102" name="__codelineno-16-102"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;PASSED&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;FAILED&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-16-103"><a id="__codelineno-16-103" name="__codelineno-16-103"></a>
</span><span id="__span-16-104"><a id="__codelineno-16-104" name="__codelineno-16-104"></a><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">vec</span><span class="p">;</span>
</span><span id="__span-16-105"><a id="__codelineno-16-105" name="__codelineno-16-105"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-106"><a id="__codelineno-16-106" name="__codelineno-16-106"></a><span class="w">    </span><span class="c1">// Catches exceptions in the host code.</span>
</span><span id="__span-16-107"><a id="__codelineno-16-107" name="__codelineno-16-107"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Caught a SYCL host exception:</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-16-108"><a id="__codelineno-16-108" name="__codelineno-16-108"></a>
</span><span id="__span-16-109"><a id="__codelineno-16-109" name="__codelineno-16-109"></a><span class="w">    </span><span class="c1">// Most likely the runtime couldn&#39;t find FPGA hardware!</span>
</span><span id="__span-16-110"><a id="__codelineno-16-110" name="__codelineno-16-110"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">code</span><span class="p">().</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CL_DEVICE_NOT_FOUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-111"><a id="__codelineno-16-111" name="__codelineno-16-111"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting an FPGA, please ensure that your &quot;</span>
</span><span id="__span-16-112"><a id="__codelineno-16-112" name="__codelineno-16-112"></a><span class="w">                   </span><span class="s">&quot;system has a correctly configured FPGA board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-16-113"><a id="__codelineno-16-113" name="__codelineno-16-113"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Run sys_check in the oneAPI root directory to verify.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-16-114"><a id="__codelineno-16-114" name="__codelineno-16-114"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting the FPGA emulator, compile with &quot;</span>
</span><span id="__span-16-115"><a id="__codelineno-16-115" name="__codelineno-16-115"></a><span class="w">                   </span><span class="s">&quot;-DFPGA_EMULATOR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-16-116"><a id="__codelineno-16-116" name="__codelineno-16-116"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-117"><a id="__codelineno-16-117" name="__codelineno-16-117"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">terminate</span><span class="p">();</span>
</span><span id="__span-16-118"><a id="__codelineno-16-118" name="__codelineno-16-118"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-16-119"><a id="__codelineno-16-119" name="__codelineno-16-119"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
</span><span id="__span-16-120"><a id="__codelineno-16-120" name="__codelineno-16-120"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></li>
</ul>
</div>
<div class="tabbed-block">
<div class="language-cpp highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">  1</a></span>
<span class="normal"><a href="#__codelineno-17-2">  2</a></span>
<span class="normal"><a href="#__codelineno-17-3">  3</a></span>
<span class="normal"><a href="#__codelineno-17-4">  4</a></span>
<span class="normal"><a href="#__codelineno-17-5">  5</a></span>
<span class="normal"><a href="#__codelineno-17-6">  6</a></span>
<span class="normal"><a href="#__codelineno-17-7">  7</a></span>
<span class="normal"><a href="#__codelineno-17-8">  8</a></span>
<span class="normal"><a href="#__codelineno-17-9">  9</a></span>
<span class="normal"><a href="#__codelineno-17-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-17-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-17-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-17-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-17-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-17-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-17-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-17-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-17-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-17-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-17-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-17-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-17-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-17-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-17-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-17-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-17-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-17-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-17-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-17-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-17-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-17-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-17-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-17-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-17-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-17-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-17-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-17-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-17-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-17-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-17-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-17-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-17-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-17-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-17-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-17-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-17-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-17-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-17-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-17-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-17-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-17-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-17-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-17-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-17-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-17-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-17-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-17-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-17-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-17-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-17-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-17-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-17-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-17-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-17-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-17-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-17-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-17-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-17-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-17-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-17-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-17-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-17-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-17-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-17-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-17-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-17-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-17-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-17-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-17-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-17-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-17-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-17-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-17-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-17-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-17-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-17-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-17-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-17-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-17-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-17-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-17-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-17-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-17-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-17-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-17-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-17-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-17-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-17-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-17-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-17-100">100</a></span>
<span class="normal"><a href="#__codelineno-17-101">101</a></span>
<span class="normal"><a href="#__codelineno-17-102">102</a></span>
<span class="normal"><a href="#__codelineno-17-103">103</a></span>
<span class="normal"><a href="#__codelineno-17-104">104</a></span>
<span class="normal"><a href="#__codelineno-17-105">105</a></span>
<span class="normal"><a href="#__codelineno-17-106">106</a></span>
<span class="normal"><a href="#__codelineno-17-107">107</a></span>
<span class="normal"><a href="#__codelineno-17-108">108</a></span>
<span class="normal"><a href="#__codelineno-17-109">109</a></span>
<span class="normal"><a href="#__codelineno-17-110">110</a></span>
<span class="normal"><a href="#__codelineno-17-111">111</a></span>
<span class="normal"><a href="#__codelineno-17-112">112</a></span>
<span class="normal"><a href="#__codelineno-17-113">113</a></span>
<span class="normal"><a href="#__codelineno-17-114">114</a></span>
<span class="normal"><a href="#__codelineno-17-115">115</a></span>
<span class="normal"><a href="#__codelineno-17-116">116</a></span>
<span class="normal"><a href="#__codelineno-17-117">117</a></span>
<span class="normal"><a href="#__codelineno-17-118">118</a></span>
<span class="normal"><a href="#__codelineno-17-119">119</a></span>
<span class="normal"><a href="#__codelineno-17-120">120</a></span>
<span class="normal"><a href="#__codelineno-17-121">121</a></span>
<span class="normal"><a href="#__codelineno-17-122">122</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="c1">// oneAPI headers</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/ext/intel/fpga_extensions.hpp&gt;</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sycl/sycl.hpp&gt;</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="c1">// Forward declare the kernel name in the global scope. This is an FPGA best</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="c1">// practice that reduces name mangling in the optimization reports.</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">Accumulator</span><span class="p">;</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="c1">// Initialization cycle (let us take a bit more than 10)</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="k">constexpr</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">II_CYCLES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="p">;</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">    </span><span class="c1">// Use compile-time macros to select either:</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="w">    </span><span class="c1">//  - the FPGA emulator device (CPU emulation of the FPGA)</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="w">    </span><span class="c1">//  - the FPGA device (a real FPGA)</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="w">    </span><span class="c1">//  - the simulator device</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="cp">#if FPGA_SIMULATOR</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_simulator_selector_v</span><span class="p">;</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="cp">#elif FPGA_HARDWARE</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_selector_v</span><span class="p">;</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="cp">#else  </span><span class="c1">// #if FPGA_EMULATOR</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">ext</span><span class="o">::</span><span class="n">intel</span><span class="o">::</span><span class="n">fpga_emulator_selector_v</span><span class="p">;</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="cp">#endif</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29"></a>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30"></a><span class="w">    </span><span class="c1">// create the device queue</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31"></a><span class="w">    </span><span class="n">sycl</span><span class="o">::</span><span class="n">queue</span><span class="w"> </span><span class="n">q</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32"></a>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33"></a><span class="w">    </span><span class="c1">// make sure the device supports USM host allocations</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34"></a><span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">device</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span><span class="p">.</span><span class="n">get_device</span><span class="p">();</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35"></a>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Running on device: &quot;</span>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">device</span><span class="p">.</span><span class="n">get_info</span><span class="o">&lt;</span><span class="n">sycl</span><span class="o">::</span><span class="n">info</span><span class="o">::</span><span class="n">device</span><span class="o">::</span><span class="n">name</span><span class="o">&gt;</span><span class="p">().</span><span class="n">c_str</span><span class="p">()</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38"></a><span class="w">              </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39"></a>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40"></a><span class="w">    </span><span class="c1">// declare arrays and fill them</span>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">align_val_t</span><span class="p">{</span><span class="w"> </span><span class="mi">64</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="n">kVectSize</span><span class="p">];</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44"></a><span class="w">      </span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46"></a>
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Accumulate values &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-17-49"><a id="__codelineno-17-49" name="__codelineno-17-49"></a><span class="w">      </span><span class="c1">// copy the input arrays to buffers to share with kernel</span>
</span><span id="__span-17-50"><a id="__codelineno-17-50" name="__codelineno-17-50"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="w"> </span><span class="n">buffer_in</span><span class="p">{</span><span class="n">vec</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="p">(</span><span class="n">kVectSize</span><span class="p">)};</span>
</span><span id="__span-17-51"><a id="__codelineno-17-51" name="__codelineno-17-51"></a><span class="w">      </span><span class="n">sycl</span><span class="o">::</span><span class="n">buffer</span><span class="w"> </span><span class="n">buffer_out</span><span class="p">{</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">range</span><span class="p">(</span><span class="mi">1</span><span class="p">)};</span>
</span><span id="__span-17-52"><a id="__codelineno-17-52" name="__codelineno-17-52"></a>
</span><span id="__span-17-53"><a id="__codelineno-17-53" name="__codelineno-17-53"></a><span class="w">      </span><span class="n">q</span><span class="p">.</span><span class="n">submit</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">sycl</span><span class="o">::</span><span class="n">handler</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-54"><a id="__codelineno-17-54" name="__codelineno-17-54"></a><span class="w">        </span><span class="c1">// use accessors to interact with buffers from device code</span>
</span><span id="__span-17-55"><a id="__codelineno-17-55" name="__codelineno-17-55"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">arr</span><span class="p">{</span><span class="n">buffer_in</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">read_only</span><span class="p">};</span>
</span><span id="__span-17-56"><a id="__codelineno-17-56" name="__codelineno-17-56"></a><span class="w">        </span><span class="n">sycl</span><span class="o">::</span><span class="n">accessor</span><span class="w"> </span><span class="n">result</span><span class="p">{</span><span class="n">buffer_out</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">sycl</span><span class="o">::</span><span class="n">write_only</span><span class="p">,</span><span class="n">sycl</span><span class="o">::</span><span class="n">no_init</span><span class="p">};</span>
</span><span id="__span-17-57"><a id="__codelineno-17-57" name="__codelineno-17-57"></a>
</span><span id="__span-17-58"><a id="__codelineno-17-58" name="__codelineno-17-58"></a><span class="w">        </span><span class="n">h</span><span class="p">.</span><span class="n">single_task</span><span class="o">&lt;</span><span class="n">Accumulator</span><span class="o">&gt;</span><span class="p">([</span><span class="o">=</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-59"><a id="__codelineno-17-59" name="__codelineno-17-59"></a><span class="w">        </span><span class="c1">//Create shift register with II_CYCLE+1 elements</span>
</span><span id="__span-17-60"><a id="__codelineno-17-60" name="__codelineno-17-60"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">II_CYCLES</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-17-61"><a id="__codelineno-17-61" name="__codelineno-17-61"></a><span class="w">        </span><span class="c1">//Initialize all elements of the register to 0</span>
</span><span id="__span-17-62"><a id="__codelineno-17-62" name="__codelineno-17-62"></a><span class="w">        </span><span class="c1">//You must initialize the shift register </span>
</span><span id="__span-17-63"><a id="__codelineno-17-63" name="__codelineno-17-63"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">II_CYCLES</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-64"><a id="__codelineno-17-64" name="__codelineno-17-64"></a><span class="w">          </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-17-65"><a id="__codelineno-17-65" name="__codelineno-17-65"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-17-66"><a id="__codelineno-17-66" name="__codelineno-17-66"></a><span class="w">        </span><span class="c1">//Iterate through every element of input array</span>
</span><span id="__span-17-67"><a id="__codelineno-17-67" name="__codelineno-17-67"></a><span class="w">        </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span><span id="__span-17-68"><a id="__codelineno-17-68" name="__codelineno-17-68"></a><span class="w">           </span><span class="c1">//Load ith element into end of shift register</span>
</span><span id="__span-17-69"><a id="__codelineno-17-69" name="__codelineno-17-69"></a><span class="w">           </span><span class="c1">//if N &gt; II_CYCLE, add to shift_reg[0] to preserve values</span>
</span><span id="__span-17-70"><a id="__codelineno-17-70" name="__codelineno-17-70"></a><span class="w">           </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">II_CYCLES</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-17-71"><a id="__codelineno-17-71" name="__codelineno-17-71"></a>
</span><span id="__span-17-72"><a id="__codelineno-17-72" name="__codelineno-17-72"></a><span class="w">           </span><span class="cp">#pragma unroll</span>
</span><span id="__span-17-73"><a id="__codelineno-17-73" name="__codelineno-17-73"></a><span class="w">           </span><span class="c1">//Shift every element of shift register</span>
</span><span id="__span-17-74"><a id="__codelineno-17-74" name="__codelineno-17-74"></a><span class="w">           </span><span class="c1">//Done in 1 cycle if using loop unrolling</span>
</span><span id="__span-17-75"><a id="__codelineno-17-75" name="__codelineno-17-75"></a><span class="w">           </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">II_CYCLES</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">){</span>
</span><span id="__span-17-76"><a id="__codelineno-17-76" name="__codelineno-17-76"></a><span class="w">              </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-17-77"><a id="__codelineno-17-77" name="__codelineno-17-77"></a><span class="w">           </span><span class="p">}</span>
</span><span id="__span-17-78"><a id="__codelineno-17-78" name="__codelineno-17-78"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span>
</span><span id="__span-17-79"><a id="__codelineno-17-79" name="__codelineno-17-79"></a><span class="w">       </span><span class="c1">//Sum every element of shift register</span>
</span><span id="__span-17-80"><a id="__codelineno-17-80" name="__codelineno-17-80"></a><span class="w">       </span><span class="kt">double</span><span class="w"> </span><span class="n">temp_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-17-81"><a id="__codelineno-17-81" name="__codelineno-17-81"></a><span class="w">       </span><span class="cp">#pragma unroll</span>
</span><span id="__span-17-82"><a id="__codelineno-17-82" name="__codelineno-17-82"></a><span class="w">       </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">II_CYCLES</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
</span><span id="__span-17-83"><a id="__codelineno-17-83" name="__codelineno-17-83"></a><span class="w">          </span><span class="n">temp_sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">shift_reg</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-17-84"><a id="__codelineno-17-84" name="__codelineno-17-84"></a><span class="w">       </span><span class="p">}</span>
</span><span id="__span-17-85"><a id="__codelineno-17-85" name="__codelineno-17-85"></a><span class="w">       </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_sum</span><span class="p">;</span>
</span><span id="__span-17-86"><a id="__codelineno-17-86" name="__codelineno-17-86"></a><span class="w">             </span><span class="p">});</span>
</span><span id="__span-17-87"><a id="__codelineno-17-87" name="__codelineno-17-87"></a><span class="w">           </span><span class="p">});</span>
</span><span id="__span-17-88"><a id="__codelineno-17-88" name="__codelineno-17-88"></a><span class="w">         </span><span class="p">}</span>
</span><span id="__span-17-89"><a id="__codelineno-17-89" name="__codelineno-17-89"></a><span class="w">    </span><span class="c1">// result is copied back to host automatically when accessors go out of</span>
</span><span id="__span-17-90"><a id="__codelineno-17-90" name="__codelineno-17-90"></a><span class="w">    </span><span class="c1">// scope.</span>
</span><span id="__span-17-91"><a id="__codelineno-17-91" name="__codelineno-17-91"></a>
</span><span id="__span-17-92"><a id="__codelineno-17-92" name="__codelineno-17-92"></a><span class="w">    </span><span class="c1">// verify that Accumulation is correct</span>
</span><span id="__span-17-93"><a id="__codelineno-17-93" name="__codelineno-17-93"></a><span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-17-94"><a id="__codelineno-17-94" name="__codelineno-17-94"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">kVectSize</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-17-95"><a id="__codelineno-17-95" name="__codelineno-17-95"></a><span class="w">      </span><span class="n">expected</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-17-96"><a id="__codelineno-17-96" name="__codelineno-17-96"></a>
</span><span id="__span-17-97"><a id="__codelineno-17-97" name="__codelineno-17-97"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-98"><a id="__codelineno-17-98" name="__codelineno-17-98"></a><span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;res = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w">  </span><span class="s">&quot;, expected = &quot;</span>
</span><span id="__span-17-99"><a id="__codelineno-17-99" name="__codelineno-17-99"></a><span class="w">                  </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-17-100"><a id="__codelineno-17-100" name="__codelineno-17-100"></a><span class="w">        </span><span class="n">passed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span id="__span-17-101"><a id="__codelineno-17-101" name="__codelineno-17-101"></a><span class="w">      </span><span class="p">}</span>
</span><span id="__span-17-102"><a id="__codelineno-17-102" name="__codelineno-17-102"></a>
</span><span id="__span-17-103"><a id="__codelineno-17-103" name="__codelineno-17-103"></a>
</span><span id="__span-17-104"><a id="__codelineno-17-104" name="__codelineno-17-104"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&quot;PASSED&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;FAILED&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span id="__span-17-105"><a id="__codelineno-17-105" name="__codelineno-17-105"></a>
</span><span id="__span-17-106"><a id="__codelineno-17-106" name="__codelineno-17-106"></a><span class="w">    </span><span class="k">delete</span><span class="p">[]</span><span class="w"> </span><span class="n">vec</span><span class="p">;</span>
</span><span id="__span-17-107"><a id="__codelineno-17-107" name="__codelineno-17-107"></a><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">sycl</span><span class="o">::</span><span class="n">exception</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="o">&amp;</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-108"><a id="__codelineno-17-108" name="__codelineno-17-108"></a><span class="w">    </span><span class="c1">// Catches exceptions in the host code.</span>
</span><span id="__span-17-109"><a id="__codelineno-17-109" name="__codelineno-17-109"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Caught a SYCL host exception:</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-17-110"><a id="__codelineno-17-110" name="__codelineno-17-110"></a>
</span><span id="__span-17-111"><a id="__codelineno-17-111" name="__codelineno-17-111"></a><span class="w">    </span><span class="c1">// Most likely the runtime couldn&#39;t find FPGA hardware!</span>
</span><span id="__span-17-112"><a id="__codelineno-17-112" name="__codelineno-17-112"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">code</span><span class="p">().</span><span class="n">value</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CL_DEVICE_NOT_FOUND</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-113"><a id="__codelineno-17-113" name="__codelineno-17-113"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting an FPGA, please ensure that your &quot;</span>
</span><span id="__span-17-114"><a id="__codelineno-17-114" name="__codelineno-17-114"></a><span class="w">                   </span><span class="s">&quot;system has a correctly configured FPGA board.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-17-115"><a id="__codelineno-17-115" name="__codelineno-17-115"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Run sys_check in the oneAPI root directory to verify.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-17-116"><a id="__codelineno-17-116" name="__codelineno-17-116"></a><span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;If you are targeting the FPGA emulator, compile with &quot;</span>
</span><span id="__span-17-117"><a id="__codelineno-17-117" name="__codelineno-17-117"></a><span class="w">                   </span><span class="s">&quot;-DFPGA_EMULATOR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span id="__span-17-118"><a id="__codelineno-17-118" name="__codelineno-17-118"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-119"><a id="__codelineno-17-119" name="__codelineno-17-119"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">terminate</span><span class="p">();</span>
</span><span id="__span-17-120"><a id="__codelineno-17-120" name="__codelineno-17-120"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-17-121"><a id="__codelineno-17-121" name="__codelineno-17-121"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">EXIT_SUCCESS</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">EXIT_FAILURE</span><span class="p">;</span>
</span><span id="__span-17-122"><a id="__codelineno-17-122" name="__codelineno-17-122"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<h2 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h2>
<div class="admonition success">
<p class="admonition-title">We have seen</p>
<ul>
<li>The anatomy of SYCL program</li>
<li>How to manage data movement between host and device for FPGA<ul>
<li>Explicit data movement with USM</li>
<li>Implicit data movement with Buffers &amp; accessors  </li>
</ul>
</li>
<li>How to manage data dependencies between kernels<ul>
<li>Explicit dependencies with events</li>
<li>Implicit dependencies using buffers access mode </li>
</ul>
</li>
<li>How to define kernels and the importance of pipelining in FPGA<ul>
<li>ND-range kernel created with the <code>parallel_for</code> method</li>
<li>Single-work item kernel with the <code>single_task</code> method</li>
</ul>
</li>
</ul>
</div>
<div class="admonition failure">
<p class="admonition-title">We did not see</p>
<ul>
<li>Hierachical Parallels kernels</li>
<li>Memory models and atomics</li>
<li>The DPC++ Parallel STL</li>
</ul>
</div>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">May 14, 2024</span>
  </span>

    
    
    
    
  </aside>





                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2023 LuxProvide
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.expand", "content.code.copy", "content.code.select"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
        <script src="../javascripts/extra.js"></script>
      
        <script src="../javascripts/bootstrap.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tablesort/5.2.1/tablesort.min.js"></script>
      
        <script src="../javascripts/tables.js"></script>
      
        <script src="../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>